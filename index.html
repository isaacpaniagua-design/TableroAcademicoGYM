<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tablero de Control Acad√©mico - ITSON</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-shadow {
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .hover-scale {
            transition: transform 0.2s ease;
        }
        .hover-scale:hover {
            transform: scale(1.02);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen gradient-bg flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl card-shadow p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <div class="bg-blue-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-graduation-cap text-3xl text-blue-600"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-800 mb-2">Control Acad√©mico ITSON</h1>
                <p class="text-gray-600">Sistema de Gesti√≥n Docente</p>
            </div>
            
            <form id="loginForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Correo Electr√≥nico</label>
                    <input type="email" id="loginEmail" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="usuario@itson.edu.mx">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Contrase√±a</label>
                    <input type="password" id="loginPassword" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                
                <button type="submit" 
                        class="w-full bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700 transition-colors">
                    <i class="fas fa-sign-in-alt mr-2"></i>Iniciar Sesi√≥n
                </button>
            </form>
            
            <div class="mt-6 text-center">
                <div class="loading-indicator hidden">
                    <div class="flex items-center justify-center space-x-2">
                        <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"></div>
                        <span class="text-sm text-gray-600">Conectando con Google Sheets...</span>
                    </div>
                </div>
                <p class="text-sm text-gray-500">
                    Credenciales: isaac.paniagua@itson.edu.mx / admin123
                </p>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" class="hidden">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="bg-blue-100 w-10 h-10 rounded-full flex items-center justify-center">
                            <i class="fas fa-graduation-cap text-blue-600"></i>
                        </div>
                        <div>
                            <h1 class="text-xl font-bold text-gray-800">Control Acad√©mico ITSON</h1>
                            <p class="text-sm text-gray-600" id="userWelcome">Bienvenido, Isaac Paniagua</p>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <div class="text-right">
                            <p class="text-sm font-medium text-gray-800" id="currentUserName">Isaac Paniagua</p>
                            <p class="text-xs text-gray-500" id="currentUserRole">Administrador</p>
                        </div>
                        <button onclick="logout()" class="text-gray-500 hover:text-red-600 transition-colors">
                            <i class="fas fa-sign-out-alt text-lg"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <div class="bg-white border-b">
            <div class="px-6">
                <nav class="flex space-x-8">
                    <button onclick="showTab('overview')" id="tab-overview" 
                            class="py-4 px-2 border-b-2 border-blue-500 text-blue-600 font-medium">
                        <i class="fas fa-chart-dashboard mr-2"></i>Resumen
                    </button>
                    <button onclick="showTab('users')" id="tab-users" 
                            class="py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium">
                        <i class="fas fa-users mr-2"></i>Gesti√≥n de Usuarios
                    </button>
                    <button onclick="showTab('activities')" id="tab-activities" 
                            class="py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium">
                        <i class="fas fa-tasks mr-2"></i>Actividades
                    </button>
                    <button onclick="showTab('reports')" id="tab-reports" 
                            class="py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium">
                        <i class="fas fa-chart-bar mr-2"></i>Reportes
                    </button>
                </nav>
            </div>
        </div>

        <!-- Content Area -->
        <main class="p-6">
            <!-- Overview Tab -->
            <div id="content-overview" class="tab-content">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <!-- Stats Cards -->
                    <div class="bg-white rounded-xl card-shadow p-6 hover-scale">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Total Docentes</p>
                                <p class="text-3xl font-bold text-gray-900" id="totalTeachers">0</p>
                            </div>
                            <div class="bg-blue-100 w-12 h-12 rounded-full flex items-center justify-center">
                                <i class="fas fa-chalkboard-teacher text-blue-600"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl card-shadow p-6 hover-scale">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Actividades Activas</p>
                                <p class="text-3xl font-bold text-gray-900" id="activeActivities">0</p>
                            </div>
                            <div class="bg-green-100 w-12 h-12 rounded-full flex items-center justify-center">
                                <i class="fas fa-tasks text-green-600"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl card-shadow p-6 hover-scale">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Ing. Software</p>
                                <p class="text-3xl font-bold text-gray-900" id="softwareTeachers">0</p>
                            </div>
                            <div class="bg-purple-100 w-12 h-12 rounded-full flex items-center justify-center">
                                <i class="fas fa-code text-purple-600"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl card-shadow p-6 hover-scale">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Ing. Mecatr√≥nica</p>
                                <p class="text-3xl font-bold text-gray-900" id="mechatronicsTeachers">0</p>
                            </div>
                            <div class="bg-orange-100 w-12 h-12 rounded-full flex items-center justify-center">
                                <i class="fas fa-cogs text-orange-600"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Google Sheets Status -->
                <div class="bg-white rounded-xl card-shadow p-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">
                        <i class="fas fa-cloud mr-2 text-green-600"></i>Estado de Google Sheets
                    </h3>
                    <div id="sheetsStatus" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Status will be populated here -->
                    </div>
                </div>

                <!-- Recent Activities -->
                <div class="bg-white rounded-xl card-shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">
                        <i class="fas fa-clock mr-2 text-blue-600"></i>Actividades Recientes
                    </h3>
                    <div class="space-y-4" id="recentActivities">
                        <!-- Recent activities will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Users Management Tab -->
            <div id="content-users" class="tab-content hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Gesti√≥n de Usuarios</h2>
                    <button onclick="showAddUserModal()" 
                            class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-plus mr-2"></i>Agregar Usuario
                    </button>
                </div>

                <!-- Filter Tabs -->
                <div class="bg-white rounded-xl card-shadow mb-6">
                    <div class="p-4 border-b">
                        <div class="flex space-x-4">
                            <button onclick="filterUsers('all')" id="filter-all" 
                                    class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg font-medium">
                                Todos
                            </button>
                            <button onclick="filterUsers('software')" id="filter-software" 
                                    class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg font-medium">
                                Ing. Software
                            </button>
                            <button onclick="filterUsers('mechatronics')" id="filter-mechatronics" 
                                    class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg font-medium">
                                Ing. Mecatr√≥nica
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-4">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="text-left text-sm font-medium text-gray-600">
                                        <th class="pb-3">Usuario</th>
                                        <th class="pb-3">Programa</th>
                                        <th class="pb-3">Rol</th>
                                        <th class="pb-3">Estado</th>
                                        <th class="pb-3">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTable" class="text-sm">
                                    <!-- Users will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Activities Tab -->
            <div id="content-activities" class="tab-content hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Gesti√≥n de Actividades</h2>
                    <button onclick="showAddActivityModal()" 
                            class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                        <i class="fas fa-plus mr-2"></i>Nueva Actividad
                    </button>
                </div>

                <div class="bg-white rounded-xl card-shadow">
                    <div class="p-6">
                        <div id="activitiesList">
                            <!-- Activities will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="content-reports" class="tab-content hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Reportes y Estad√≠sticas</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white rounded-xl card-shadow p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Progreso por Programa</h3>
                        <div class="space-y-4">
                            <div>
                                <div class="flex justify-between text-sm mb-1">
                                    <span>Ingenier√≠a en Software</span>
                                    <span id="softwareProgress">0%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-purple-600 h-2 rounded-full" id="softwareProgressBar" style="width: 0%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between text-sm mb-1">
                                    <span>Ing. Mecatr√≥nica y Manufactura</span>
                                    <span id="mechatronicsProgress">0%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-orange-600 h-2 rounded-full" id="mechatronicsProgressBar" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl card-shadow p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Actividades por Estado</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Completadas</span>
                                <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-medium" id="completedCount">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">En Progreso</span>
                                <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full text-xs font-medium" id="inProgressCount">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Pendientes</span>
                                <span class="bg-red-100 text-red-800 px-2 py-1 rounded-full text-xs font-medium" id="pendingCount">0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Admin Panel -->
                <div id="adminPanel" class="bg-white rounded-xl card-shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">
                        <i class="fas fa-shield-alt mr-2 text-red-600"></i>Panel de Administraci√≥n
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium text-blue-800">Sincronizaci√≥n</span>
                                <i class="fas fa-sync-alt text-blue-600" id="syncIcon"></i>
                            </div>
                            <p class="text-xs text-blue-600" id="syncStatus">Conectando...</p>
                        </div>
                        
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium text-green-800">√öltima Actualizaci√≥n</span>
                                <i class="fas fa-clock text-green-600"></i>
                            </div>
                            <p class="text-xs text-green-600" id="lastUpdateTime">Cargando...</p>
                        </div>
                        
                        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium text-purple-800">Total Registros</span>
                                <i class="fas fa-chart-bar text-purple-600"></i>
                            </div>
                            <p class="text-xs text-purple-600" id="totalRecords">Calculando...</p>
                        </div>
                    </div>
                    
                    <div class="border-t pt-4">
                        <h4 class="font-medium text-gray-800 mb-3">Acciones de Administrador</h4>
                        <div class="flex flex-wrap gap-3">
                            <button onclick="syncWithSheets()" 
                                    class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm">
                                <i class="fas fa-sync mr-2"></i>Sincronizar con Sheets
                            </button>
                            
                            <button onclick="exportData()" 
                                    class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors text-sm">
                                <i class="fas fa-download mr-2"></i>Exportar Datos
                            </button>
                            
                            <button onclick="showDataSummary()" 
                                    class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors text-sm">
                                <i class="fas fa-chart-line mr-2"></i>Resumen Detallado
                            </button>
                            
                            <button onclick="clearAllData()" 
                                    class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors text-sm">
                                <i class="fas fa-trash-alt mr-2"></i>Reiniciar Sistema
                            </button>
                        </div>
                    </div>
                    
                    <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <p class="text-sm text-yellow-800">
                            <i class="fas fa-info-circle mr-2"></i>
                            <strong>Importante:</strong> Los datos se sincronizan autom√°ticamente con Google Sheets. Usa "Sincronizar" para forzar una actualizaci√≥n.
                        </p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl max-w-md w-full p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">Agregar Nuevo Usuario</h3>
                <button onclick="closeAddUserModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="addUserForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nombre Completo</label>
                    <input type="text" id="newUserName" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Correo Electr√≥nico</label>
                    <input type="email" id="newUserEmail" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Programa Educativo</label>
                    <select id="newUserProgram" required 
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">Seleccionar programa</option>
                        <option value="software">Ingenier√≠a en Software</option>
                        <option value="mechatronics">Ing. Mecatr√≥nica y Manufactura</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Rol</label>
                    <select id="newUserRole" required 
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">Seleccionar rol</option>
                        <option value="docente">Docente</option>
                        <option value="auxiliar">Profesor Auxiliar</option>
                        <option value="admin">Administrador</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Especialidad</label>
                    <input type="text" id="newUserSpecialty" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                           placeholder="Ej: Desarrollo Web, Inteligencia Artificial">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tel√©fono</label>
                    <input type="tel" id="newUserPhone" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                           placeholder="Ej: +52 644 123 4567">
                </div>
                
                <div class="flex space-x-3 pt-4">
                    <button type="submit" 
                            class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        Agregar Usuario
                    </button>
                    <button type="button" onclick="closeAddUserModal()" 
                            class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition-colors">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Activity Modal -->
    <div id="addActivityModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl max-w-md w-full p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">Nueva Actividad</h3>
                <button onclick="closeAddActivityModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="addActivityForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">T√≠tulo de la Actividad</label>
                    <input type="text" id="newActivityTitle" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Descripci√≥n</label>
                    <textarea id="newActivityDescription" rows="3" 
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Programa Educativo</label>
                    <select id="newActivityProgram" required 
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">Seleccionar programa</option>
                        <option value="software">Ingenier√≠a en Software</option>
                        <option value="mechatronics">Ing. Mecatr√≥nica y Manufactura</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Asignar a Docente</label>
                    <select id="newActivityTeacher" required 
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">Seleccionar docente</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Prioridad</label>
                    <select id="newActivityPriority" required 
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="baja">Baja</option>
                        <option value="media" selected>Media</option>
                        <option value="alta">Alta</option>
                        <option value="urgente">Urgente</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Fecha L√≠mite</label>
                    <input type="date" id="newActivityDeadline" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div class="flex space-x-3 pt-4">
                    <button type="submit" 
                            class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition-colors">
                        Crear Actividad
                    </button>
                    <button type="button" onclick="closeAddActivityModal()" 
                            class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition-colors">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Google Sheets Configuration - REAL INTEGRATION
        const GOOGLE_SHEETS_CONFIG = {
            software: {
                id: '11DL5I9Zcxm-SdQ9cXRAO-j_InMYHs36qZOk6QRIVMKI',
                docentesSheet: 'Docentes',
                actividadesSheet: 'Actividades',
                progresoSheet: 'Progreso',
                usuariosSheet: 'Usuarios'
            },
            mechatronics: {
                id: '1hO1kMdw7LDlXePyjJRj4d4dd-v7cQ1dm8TCkU7izqR8',
                docentesSheet: 'Docentes',
                actividadesSheet: 'Actividades', 
                progresoSheet: 'Progreso',
                usuariosSheet: 'Usuarios'
            }
        };

        // Global variables
        let currentUser = null;
        let users = [];
        let activities = [];
        let isLoading = false;
        let sheetsConnected = false;

        // Persistent Storage System
        const STORAGE_KEYS = {
            USERS: 'itson_users_data',
            ACTIVITIES: 'itson_activities_data',
            CURRENT_USER: 'itson_current_user',
            LAST_SYNC: 'itson_last_sync'
        };

        // REAL Google Sheets Integration Functions
        function getSheetUrl(program, sheetName, range = '') {
            const sheetId = GOOGLE_SHEETS_CONFIG[program].id;
            const baseUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=${sheetName}`;
            return range ? `${baseUrl}&range=${range}` : baseUrl;
        }

        function getSheetEditUrl(program, sheetName) {
            const sheetId = GOOGLE_SHEETS_CONFIG[program].id;
            return `https://docs.google.com/spreadsheets/d/${sheetId}/edit#gid=0`;
        }

        async function fetchFromGoogleSheets(program, sheetName, range = '') {
            try {
                const url = getSheetUrl(program, sheetName, range);
                console.log(`Fetching from: ${url}`);
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const text = await response.text();
                
                // Parse Google Sheets JSON response
                const jsonString = text.substring(47).slice(0, -2);
                const data = JSON.parse(jsonString);
                
                if (!data.table || !data.table.rows) {
                    console.log(`No data found in ${program} - ${sheetName}`);
                    return [];
                }
                
                const rows = data.table.rows.map(row => {
                    const cells = row.c || [];
                    return cells.map(cell => cell ? (cell.v || '') : '');
                });
                
                console.log(`Loaded ${rows.length} rows from ${program} - ${sheetName}`);
                return rows;
                
            } catch (error) {
                console.error(`Error fetching data from ${program} - ${sheetName}:`, error);
                showNotification(`Error conectando con ${program} - ${sheetName}`, 'error');
                return [];
            }
        }

        // REAL function to append data to Google Sheets
        async function appendToGoogleSheet(program, sheetName, data) {
            try {
                // Since we can't directly write to Google Sheets from frontend without API key,
                // we'll use the Google Forms approach or show instructions
                
                const sheetId = GOOGLE_SHEETS_CONFIG[program].id;
                const editUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/edit`;
                
                // For now, we'll save locally and provide instructions
                console.log(`Data to append to ${program} - ${sheetName}:`, data);
                
                // Save to local storage as backup
                saveDataToStorage();
                
                // Show user the data that should be added to sheets
                showSheetsInstructions(program, sheetName, data);
                
                return true;
                
            } catch (error) {
                console.error(`Error appending to ${program} - ${sheetName}:`, error);
                throw error;
            }
        }

        function showSheetsInstructions(program, sheetName, data) {
            const programName = program === 'software' ? 'Ingenier√≠a en Software' : 'Ing. Mecatr√≥nica';
            const sheetId = GOOGLE_SHEETS_CONFIG[program].id;
            const editUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/edit`;
            
            let dataString = '';
            if (Array.isArray(data)) {
                dataString = data.join('\t'); // Tab separated for easy pasting
            } else {
                dataString = Object.values(data).join('\t');
            }
            
            const instructions = `
üìã DATOS GUARDADOS LOCALMENTE - SINCRONIZACI√ìN REQUERIDA

üéØ Programa: ${programName}
üìä Hoja: ${sheetName}
üìù Datos a agregar: ${dataString}

üîó Enlace a la hoja: ${editUrl}

‚ö†Ô∏è INSTRUCCIONES:
1. Haz clic en el enlace de arriba
2. Ve a la hoja "${sheetName}"
3. Agrega una nueva fila con los datos mostrados
4. Los datos ya est√°n guardados localmente como respaldo

‚úÖ El sistema continuar√° funcionando normalmente con los datos locales.
            `;
            
            // Create a modal with instructions
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl max-w-2xl w-full p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">
                            <i class="fas fa-cloud-upload-alt mr-2 text-blue-600"></i>
                            Sincronizaci√≥n con Google Sheets
                        </h3>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                        <pre class="text-sm text-blue-800 whitespace-pre-wrap">${instructions}</pre>
                    </div>
                    <div class="flex space-x-3">
                        <a href="${editUrl}" target="_blank" 
                           class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors text-center">
                            <i class="fas fa-external-link-alt mr-2"></i>Abrir Google Sheets
                        </a>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors">
                            Cerrar
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // Initialize system with REAL Google Sheets integration
        async function initializeGoogleSheets() {
            try {
                setLoadingState(true);
                updateSyncStatus('Conectando con Google Sheets...', 'loading');
                
                // Load persistent data first
                loadDataFromStorage();
                
                // Try to connect to Google Sheets
                let sheetsData = await loadDataFromSheets();
                
                if (sheetsData.success) {
                    sheetsConnected = true;
                    updateSyncStatus('Conectado con Google Sheets', 'success');
                    showNotification('Datos sincronizados con Google Sheets', 'success');
                } else {
                    sheetsConnected = false;
                    updateSyncStatus('Usando datos locales', 'warning');
                    showNotification('Usando almacenamiento local. Datos guardados permanentemente.', 'info');
                }
                
                // If no local data exists, create initial data
                if (users.length === 0) {
                    createInitialData();
                    saveDataToStorage();
                }
                
                setLoadingState(false);
                updateSheetsStatus();
                
            } catch (error) {
                console.error('Error initializing system:', error);
                setLoadingState(false);
                sheetsConnected = false;
                updateSyncStatus('Error de conexi√≥n', 'error');
                
                // Fallback to local storage
                loadDataFromStorage();
                if (users.length === 0) {
                    createInitialData();
                    saveDataToStorage();
                }
                
                showNotification('Sistema iniciado en modo local. Los datos se guardan permanentemente.', 'info');
            }
        }

        async function loadDataFromSheets() {
            let success = false;
            let loadedUsers = 0;
            let loadedActivities = 0;
            
            try {
                // Load users from both programs
                for (const program of ['software', 'mechatronics']) {
                    try {
                        // Load from Usuarios sheet
                        const userData = await fetchFromGoogleSheets(program, GOOGLE_SHEETS_CONFIG[program].usuariosSheet);
                        if (userData.length > 1) { // Skip header row
                            for (let i = 1; i < userData.length; i++) {
                                const row = userData[i];
                                if (row[0] && row[1]) { // Ensure we have at least ID and email
                                    const user = {
                                        id: row[0] || `${program}-${i}`,
                                        email: row[1] || '',
                                        role: row[2] || 'docente',
                                        name: row[3] || '',
                                        program: program,
                                        createdAt: row[5] || new Date().toISOString(),
                                        status: row[6] || 'active'
                                    };
                                    
                                    // Check if user already exists
                                    const existingIndex = users.findIndex(u => u.email === user.email);
                                    if (existingIndex >= 0) {
                                        users[existingIndex] = { ...users[existingIndex], ...user };
                                    } else {
                                        users.push(user);
                                    }
                                    loadedUsers++;
                                }
                            }
                        }

                        // Load from Docentes sheet
                        const docentesData = await fetchFromGoogleSheets(program, GOOGLE_SHEETS_CONFIG[program].docentesSheet);
                        if (docentesData.length > 1) { // Skip header row
                            for (let i = 1; i < docentesData.length; i++) {
                                const row = docentesData[i];
                                if (row[0] && row[1] && row[2]) { // Ensure we have ID, name and email
                                    const existingUser = users.find(u => u.email === row[2]);
                                    if (existingUser) {
                                        // Update existing user with docente info
                                        existingUser.specialty = row[3] || '';
                                        existingUser.phone = row[4] || '';
                                        existingUser.notes = row[7] || '';
                                    } else {
                                        // Add new docente
                                        users.push({
                                            id: row[0] || `${program}-docente-${i}`,
                                            name: row[1] || '',
                                            email: row[2] || '',
                                            specialty: row[3] || '',
                                            phone: row[4] || '',
                                            program: program,
                                            role: 'docente',
                                            status: row[5] || 'active',
                                            createdAt: row[6] || new Date().toISOString(),
                                            notes: row[7] || ''
                                        });
                                        loadedUsers++;
                                    }
                                }
                            }
                        }

                        // Load activities
                        const activitiesData = await fetchFromGoogleSheets(program, GOOGLE_SHEETS_CONFIG[program].actividadesSheet);
                        if (activitiesData.length > 1) { // Skip header row
                            for (let i = 1; i < activitiesData.length; i++) {
                                const row = activitiesData[i];
                                if (row[0] && row[1]) { // Ensure we have at least ID and title
                                    const activity = {
                                        id: row[0] || `${program}-${i}`,
                                        title: row[1] || '',
                                        description: row[2] || '',
                                        deadline: row[3] || '',
                                        priority: row[4] || 'media',
                                        status: row[5] || 'pending',
                                        assignedTo: row[6] || '',
                                        createdBy: row[7] || '',
                                        createdAt: row[8] || new Date().toISOString(),
                                        completedAt: row[9] || '',
                                        notes: row[10] || '',
                                        program: program
                                    };
                                    
                                    // Check if activity already exists
                                    const existingIndex = activities.findIndex(a => a.id === activity.id);
                                    if (existingIndex >= 0) {
                                        activities[existingIndex] = activity;
                                    } else {
                                        activities.push(activity);
                                    }
                                    loadedActivities++;
                                }
                            }
                        }
                        
                        success = true;
                        
                    } catch (error) {
                        console.error(`Error loading data from ${program}:`, error);
                    }
                }
                
                // Add admin user if not exists
                if (!users.find(u => u.email === 'isaac.paniagua@itson.edu.mx')) {
                    users.unshift({
                        id: 'admin-1',
                        name: "Isaac Paniagua",
                        email: "isaac.paniagua@itson.edu.mx",
                        program: "admin",
                        role: "admin",
                        status: "active",
                        createdAt: new Date().toISOString(),
                        specialty: "Administraci√≥n del Sistema",
                        phone: "+52 644 410 0200"
                    });
                }
                
                // Save loaded data to local storage
                saveDataToStorage();
                
                console.log(`Loaded from Google Sheets: ${loadedUsers} users, ${loadedActivities} activities`);
                
            } catch (error) {
                console.error('Error loading data from sheets:', error);
                success = false;
            }
            
            return { success, loadedUsers, loadedActivities };
        }

        // Enhanced save functions with REAL Google Sheets integration
        async function saveUserToSheets(user) {
            try {
                setLoadingState(true);
                
                const newUser = {
                    ...user,
                    id: `${user.program}-${Date.now()}`,
                    createdAt: new Date().toISOString()
                };
                
                // Add to local array first
                users.push(newUser);
                
                // Save to persistent storage
                saveDataToStorage();
                
                // Prepare data for Google Sheets
                const userData = [
                    newUser.id,
                    newUser.email,
                    newUser.role,
                    newUser.name,
                    'temp_password', // Temporary password
                    newUser.createdAt,
                    newUser.status
                ];
                
                const docenteData = [
                    newUser.id,
                    newUser.name,
                    newUser.email,
                    newUser.specialty || '',
                    newUser.phone || '',
                    newUser.status,
                    newUser.createdAt,
                    newUser.notes || ''
                ];
                
                // Try to append to Google Sheets
                if (sheetsConnected) {
                    try {
                        await appendToGoogleSheet(newUser.program, 'Usuarios', userData);
                        await appendToGoogleSheet(newUser.program, 'Docentes', docenteData);
                    } catch (error) {
                        console.error('Error saving to sheets:', error);
                        showNotification('Usuario guardado localmente. Sincronizaci√≥n manual requerida.', 'warning');
                    }
                } else {
                    showSheetsInstructions(newUser.program, 'Usuarios', userData);
                }
                
                setLoadingState(false);
                showNotification('Usuario guardado exitosamente', 'success');
                
                return newUser;
                
            } catch (error) {
                setLoadingState(false);
                showNotification('Error al guardar usuario', 'error');
                throw error;
            }
        }

        async function saveActivityToSheets(activity) {
            try {
                setLoadingState(true);
                
                const newActivity = {
                    ...activity,
                    id: `${activity.program}-${Date.now()}`,
                    createdAt: new Date().toISOString()
                };
                
                // Add to local array first
                activities.push(newActivity);
                
                // Save to persistent storage
                saveDataToStorage();
                
                // Prepare data for Google Sheets
                const activityData = [
                    newActivity.id,
                    newActivity.title,
                    newActivity.description,
                    newActivity.deadline,
                    newActivity.priority,
                    newActivity.status,
                    newActivity.assignedTo,
                    newActivity.createdBy,
                    newActivity.createdAt,
                    newActivity.completedAt || '',
                    newActivity.notes || ''
                ];
                
                // Try to append to Google Sheets
                if (sheetsConnected) {
                    try {
                        await appendToGoogleSheet(newActivity.program, 'Actividades', activityData);
                    } catch (error) {
                        console.error('Error saving activity to sheets:', error);
                        showNotification('Actividad guardada localmente. Sincronizaci√≥n manual requerida.', 'warning');
                    }
                } else {
                    showSheetsInstructions(newActivity.program, 'Actividades', activityData);
                }
                
                setLoadingState(false);
                showNotification('Actividad guardada exitosamente', 'success');
                
                return newActivity;
                
            } catch (error) {
                setLoadingState(false);
                showNotification('Error al guardar actividad', 'error');
                throw error;
            }
        }

        async function updateActivityStatus(activityId, newStatus) {
            try {
                setLoadingState(true);
                
                const activity = activities.find(a => a.id === activityId);
                if (activity) {
                    activity.status = newStatus;
                    activity.updatedAt = new Date().toISOString();
                    if (newStatus === 'completed') {
                        activity.completedAt = new Date().toISOString();
                    }
                }
                
                // Save to persistent storage
                saveDataToStorage();
                
                // Note: For updates, we would need to implement a more complex Google Sheets update mechanism
                // For now, we'll just save locally and notify about manual sync
                if (sheetsConnected) {
                    showNotification('Estado actualizado localmente. Considera sincronizar con Google Sheets.', 'info');
                } else {
                    showNotification('Estado actualizado permanentemente', 'success');
                }
                
                setLoadingState(false);
                
            } catch (error) {
                setLoadingState(false);
                showNotification('Error al actualizar estado', 'error');
                throw error;
            }
        }

        // Sync function
        async function syncWithSheets() {
            try {
                setLoadingState(true);
                updateSyncStatus('Sincronizando...', 'loading');
                
                // Reload data from Google Sheets
                const result = await loadDataFromSheets();
                
                if (result.success) {
                    sheetsConnected = true;
                    updateSyncStatus('Sincronizaci√≥n completada', 'success');
                    showNotification(`Sincronizado: ${result.loadedUsers} usuarios, ${result.loadedActivities} actividades`, 'success');
                    
                    // Refresh UI
                    loadUsers();
                    loadActivities();
                    updateStats();
                    updateSheetsStatus();
                } else {
                    updateSyncStatus('Error en sincronizaci√≥n', 'error');
                    showNotification('Error al sincronizar con Google Sheets', 'error');
                }
                
                setLoadingState(false);
                
            } catch (error) {
                setLoadingState(false);
                updateSyncStatus('Error de conexi√≥n', 'error');
                showNotification('Error de conexi√≥n con Google Sheets', 'error');
                console.error('Sync error:', error);
            }
        }

        function updateSyncStatus(message, type) {
            const statusElement = document.getElementById('syncStatus');
            const iconElement = document.getElementById('syncIcon');
            
            if (statusElement) {
                statusElement.textContent = message;
            }
            
            if (iconElement) {
                iconElement.className = 'fas text-blue-600 ' + 
                    (type === 'loading' ? 'fa-sync-alt fa-spin' :
                     type === 'success' ? 'fa-check-circle' :
                     type === 'error' ? 'fa-exclamation-triangle' :
                     'fa-sync-alt');
            }
        }

        function updateSheetsStatus() {
            const statusContainer = document.getElementById('sheetsStatus');
            if (!statusContainer) return;
            
            const softwareStatus = sheetsConnected ? 'Conectado' : 'Desconectado';
            const mechatronicsStatus = sheetsConnected ? 'Conectado' : 'Desconectado';
            const statusColor = sheetsConnected ? 'green' : 'red';
            
            statusContainer.innerHTML = `
                <div class="p-3 bg-${statusColor}-50 border border-${statusColor}-200 rounded">
                    <p class="text-sm text-${statusColor}-800">
                        <i class="fas fa-${sheetsConnected ? 'check-circle' : 'times-circle'} mr-1"></i>
                        <strong>Ing. Software:</strong> ${softwareStatus}
                    </p>
                    <p class="text-xs text-${statusColor}-600 mt-1">
                        ID: ${GOOGLE_SHEETS_CONFIG.software.id}
                    </p>
                </div>
                <div class="p-3 bg-${statusColor}-50 border border-${statusColor}-200 rounded">
                    <p class="text-sm text-${statusColor}-800">
                        <i class="fas fa-${sheetsConnected ? 'check-circle' : 'times-circle'} mr-1"></i>
                        <strong>Ing. Mecatr√≥nica:</strong> ${mechatronicsStatus}
                    </p>
                    <p class="text-xs text-${statusColor}-600 mt-1">
                        ID: ${GOOGLE_SHEETS_CONFIG.mechatronics.id}
                    </p>
                </div>
            `;
        }

        // Storage functions
        function loadDataFromStorage() {
            try {
                const storedUsers = localStorage.getItem(STORAGE_KEYS.USERS);
                if (storedUsers) {
                    users = JSON.parse(storedUsers);
                }
                
                const storedActivities = localStorage.getItem(STORAGE_KEYS.ACTIVITIES);
                if (storedActivities) {
                    activities = JSON.parse(storedActivities);
                }
                
                const storedCurrentUser = localStorage.getItem(STORAGE_KEYS.CURRENT_USER);
                if (storedCurrentUser) {
                    currentUser = JSON.parse(storedCurrentUser);
                }
                
                console.log('Datos cargados desde almacenamiento local:', {
                    users: users.length,
                    activities: activities.length,
                    currentUser: currentUser?.name
                });
                
            } catch (error) {
                console.error('Error loading data from storage:', error);
                users = [];
                activities = [];
                currentUser = null;
            }
        }

        function saveDataToStorage() {
            try {
                localStorage.setItem(STORAGE_KEYS.USERS, JSON.stringify(users));
                localStorage.setItem(STORAGE_KEYS.ACTIVITIES, JSON.stringify(activities));
                localStorage.setItem(STORAGE_KEYS.CURRENT_USER, JSON.stringify(currentUser));
                localStorage.setItem(STORAGE_KEYS.LAST_SYNC, new Date().toISOString());
                
                console.log('Datos guardados en almacenamiento local');
                
            } catch (error) {
                console.error('Error saving data to storage:', error);
                showNotification('Error al guardar datos localmente', 'error');
            }
        }

        function createInitialData() {
            const adminUser = {
                id: 'admin-1',
                name: "Isaac Paniagua",
                email: "isaac.paniagua@itson.edu.mx",
                program: "admin",
                role: "admin",
                status: "active",
                createdAt: new Date().toISOString(),
                specialty: "Administraci√≥n del Sistema",
                phone: "+52 644 410 0200"
            };
            
            users.push(adminUser);
            
            // Create sample users for demonstration
            const sampleUsers = [
                {
                    id: 'software-1',
                    name: "Dr. Mar√≠a Gonz√°lez",
                    email: "maria.gonzalez@itson.edu.mx",
                    program: "software",
                    role: "docente",
                    status: "active",
                    specialty: "Desarrollo Web",
                    phone: "+52 644 123 4567",
                    createdAt: new Date().toISOString()
                },
                {
                    id: 'mechatronics-1',
                    name: "Dr. Ana Mart√≠nez",
                    email: "ana.martinez@itson.edu.mx",
                    program: "mechatronics",
                    role: "docente",
                    status: "active",
                    specialty: "Rob√≥tica Industrial",
                    phone: "+52 644 345 6789",
                    createdAt: new Date().toISOString()
                }
            ];
            
            users.push(...sampleUsers);
            
            // Create sample activities
            const sampleActivities = [
                {
                    id: 'activity-1',
                    title: "Actualizaci√≥n de Plan de Estudios",
                    description: "Revisar y actualizar el plan de estudios de Ingenier√≠a en Software",
                    program: "software",
                    assignedTo: "software-1",
                    priority: "alta",
                    status: "in-progress",
                    deadline: "2024-02-15",
                    createdBy: "admin-1",
                    createdAt: new Date().toISOString(),
                    notes: "Incluir nuevas tecnolog√≠as emergentes"
                },
                {
                    id: 'activity-2',
                    title: "Preparaci√≥n de Laboratorio",
                    description: "Configurar equipos para pr√°cticas de rob√≥tica",
                    program: "mechatronics",
                    assignedTo: "mechatronics-1",
                    priority: "media",
                    status: "pending",
                    deadline: "2024-02-20",
                    createdBy: "admin-1",
                    createdAt: new Date().toISOString()
                }
            ];
            
            activities.push(...sampleActivities);
        }

        // Utility functions
        function setLoadingState(loading) {
            isLoading = loading;
            const loadingElements = document.querySelectorAll('.loading-indicator');
            loadingElements.forEach(el => {
                el.style.display = loading ? 'flex' : 'none';
            });
            
            const buttons = document.querySelectorAll('button');
            buttons.forEach(btn => {
                btn.disabled = loading;
                if (loading) {
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            });
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm ${
                type === 'success' ? 'bg-green-500 text-white' :
                type === 'error' ? 'bg-red-500 text-white' :
                type === 'warning' ? 'bg-yellow-500 text-white' :
                'bg-blue-500 text-white'
            }`;
            
            notification.innerHTML = `
                <div class="flex items-center justify-between">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        // Authentication with persistent session
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                setLoadingState(true);
                
                // Initialize system with Google Sheets integration
                await initializeGoogleSheets();
                
                // Find user in loaded data
                const user = users.find(u => u.email === email);
                
                if (user) {
                    const isValidLogin = (user.email === 'isaac.paniagua@itson.edu.mx' && password === 'admin123') ||
                                        (user.email !== 'isaac.paniagua@itson.edu.mx' && password.length > 0);
                    
                    if (isValidLogin) {
                        currentUser = user;
                        saveDataToStorage();
                        showDashboard();
                        showNotification('Sesi√≥n iniciada exitosamente', 'success');
                    } else {
                        showNotification('Contrase√±a incorrecta', 'error');
                    }
                } else {
                    showNotification('Usuario no encontrado', 'error');
                }
                
                setLoadingState(false);
                
            } catch (error) {
                setLoadingState(false);
                showNotification('Error al conectar con el sistema', 'error');
                console.error('Login error:', error);
            }
        });

        // Check for existing session on page load
        function checkExistingSession() {
            const storedUser = localStorage.getItem(STORAGE_KEYS.CURRENT_USER);
            if (storedUser) {
                try {
                    currentUser = JSON.parse(storedUser);
                    if (currentUser && currentUser.id) {
                        initializeGoogleSheets().then(() => {
                            showDashboard();
                            showNotification(`Bienvenido de nuevo, ${currentUser.name}`, 'success');
                        });
                        return true;
                    }
                } catch (error) {
                    console.error('Error loading session:', error);
                    localStorage.removeItem(STORAGE_KEYS.CURRENT_USER);
                }
            }
            return false;
        }

        function showDashboard() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            updateUserInfo();
            loadUsers();
            loadActivities();
            updateStats();
            updateSheetsStatus();
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem(STORAGE_KEYS.CURRENT_USER);
            
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('loginForm').reset();
            
            showNotification('Sesi√≥n cerrada. Los datos se mantienen guardados.', 'info');
        }

        function updateUserInfo() {
            if (currentUser) {
                document.getElementById('currentUserName').textContent = currentUser.name;
                document.getElementById('currentUserRole').textContent = 
                    currentUser.role === 'admin' ? 'Administrador' : 
                    currentUser.role === 'auxiliar' ? 'Profesor Auxiliar' : 'Docente';
                document.getElementById('userWelcome').textContent = `Bienvenido, ${currentUser.name}`;
            }
        }

        // Tab navigation
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            document.querySelectorAll('[id^="tab-"]').forEach(tab => {
                tab.classList.remove('border-blue-500', 'text-blue-600');
                tab.classList.add('border-transparent', 'text-gray-500');
            });
            
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            
            const activeTab = document.getElementById(`tab-${tabName}`);
            activeTab.classList.add('border-blue-500', 'text-blue-600');
            activeTab.classList.remove('border-transparent', 'text-gray-500');
        }

        // Users management
        function loadUsers() {
            const tbody = document.getElementById('usersTable');
            tbody.innerHTML = '';
            
            const filteredUsers = users.filter(user => user.program !== 'admin');
            
            if (filteredUsers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="py-8 text-center text-gray-500">
                            <i class="fas fa-users text-3xl mb-2 block"></i>
                            <p>No hay usuarios registrados</p>
                            <p class="text-sm">Agrega usuarios o sincroniza con Google Sheets</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            filteredUsers.forEach(user => {
                const row = document.createElement('tr');
                row.className = 'border-t border-gray-100 hover:bg-gray-50';
                row.innerHTML = `
                    <td class="py-3">
                        <div class="flex items-center space-x-3">
                            <div class="bg-gray-100 w-8 h-8 rounded-full flex items-center justify-center">
                                <i class="fas fa-user text-gray-600 text-sm"></i>
                            </div>
                            <div>
                                <p class="font-medium text-gray-800">${user.name || 'Sin nombre'}</p>
                                <p class="text-xs text-gray-500">${user.email}</p>
                                ${user.specialty ? `<p class="text-xs text-blue-600">${user.specialty}</p>` : ''}
                                ${user.phone ? `<p class="text-xs text-gray-400"><i class="fas fa-phone mr-1"></i>${user.phone}</p>` : ''}
                            </div>
                        </div>
                    </td>
                    <td class="py-3">
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${
                            user.program === 'software' ? 'bg-purple-100 text-purple-800' : 'bg-orange-100 text-orange-800'
                        }">
                            ${user.program === 'software' ? 'Ing. Software' : 'Ing. Mecatr√≥nica'}
                        </span>
                    </td>
                    <td class="py-3">
                        <span class="text-sm text-gray-600">
                            ${user.role === 'docente' ? 'Docente' : 
                              user.role === 'auxiliar' ? 'Profesor Auxiliar' : 
                              user.role === 'admin' ? 'Administrador' : user.role}
                        </span>
                    </td>
                    <td class="py-3">
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${
                            user.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                        }">
                            ${user.status === 'active' ? 'Activo' : 'Inactivo'}
                        </span>
                    </td>
                    <td class="py-3">
                        <button onclick="editUser('${user.id}')" class="text-blue-600 hover:text-blue-800 mr-2 p-1">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteUser('${user.id}')" class="text-red-600 hover:text-red-800 p-1">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function filterUsers(program) {
            document.querySelectorAll('[id^="filter-"]').forEach(btn => {
                btn.classList.remove('bg-blue-100', 'text-blue-700');
                btn.classList.add('text-gray-600', 'hover:bg-gray-100');
            });
            
            document.getElementById(`filter-${program}`).classList.add('bg-blue-100', 'text-blue-700');
            document.getElementById(`filter-${program}`).classList.remove('text-gray-600', 'hover:bg-gray-100');
            
            loadUsers();
        }

        // Modal functions
        function showAddUserModal() {
            document.getElementById('addUserModal').classList.remove('hidden');
        }

        function closeAddUserModal() {
            document.getElementById('addUserModal').classList.add('hidden');
            document.getElementById('addUserForm').reset();
        }

        function showAddActivityModal() {
            const teacherSelect = document.getElementById('newActivityTeacher');
            teacherSelect.innerHTML = '<option value="">Seleccionar docente</option>';
            
            users.forEach(user => {
                if (user.role === 'docente' || user.role === 'auxiliar') {
                    teacherSelect.innerHTML += `<option value="${user.id}">${user.name}</option>`;
                }
            });
            
            document.getElementById('addActivityModal').classList.remove('hidden');
        }

        function closeAddActivityModal() {
            document.getElementById('addActivityModal').classList.add('hidden');
            document.getElementById('addActivityForm').reset();
        }

        // Form submissions
        document.getElementById('addUserForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const newUser = {
                name: document.getElementById('newUserName').value,
                email: document.getElementById('newUserEmail').value,
                program: document.getElementById('newUserProgram').value,
                role: document.getElementById('newUserRole').value,
                specialty: document.getElementById('newUserSpecialty').value,
                phone: document.getElementById('newUserPhone').value,
                status: 'active'
            };
            
            try {
                await saveUserToSheets(newUser);
                loadUsers();
                updateStats();
                closeAddUserModal();
            } catch (error) {
                console.error('Error adding user:', error);
            }
        });

        document.getElementById('addActivityForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const newActivity = {
                title: document.getElementById('newActivityTitle').value,
                description: document.getElementById('newActivityDescription').value,
                program: document.getElementById('newActivityProgram').value,
                assignedTo: document.getElementById('newActivityTeacher').value,
                priority: document.getElementById('newActivityPriority').value,
                status: 'pending',
                deadline: document.getElementById('newActivityDeadline').value,
                createdBy: currentUser ? currentUser.id : 'admin-1'
            };
            
            try {
                await saveActivityToSheets(newActivity);
                loadActivities();
                updateStats();
                closeAddActivityModal();
            } catch (error) {
                console.error('Error adding activity:', error);
            }
        });

        // Activities management
        function loadActivities() {
            const container = document.getElementById('activitiesList');
            container.innerHTML = '';
            
            if (activities.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-tasks text-3xl mb-2"></i>
                        <p>No hay actividades registradas</p>
                        <p class="text-sm">Agrega actividades o sincroniza con Google Sheets</p>
                    </div>
                `;
                return;
            }
            
            activities.forEach(activity => {
                const assignedUser = users.find(u => u.id === activity.assignedTo || u.email === activity.assignedTo);
                const createdByUser = users.find(u => u.id === activity.createdBy);
                
                const statusColor = activity.status === 'completed' ? 'green' : 
                                  activity.status === 'in-progress' ? 'yellow' : 'red';
                const statusText = activity.status === 'completed' ? 'Completada' : 
                                 activity.status === 'in-progress' ? 'En Progreso' : 'Pendiente';
                
                const priorityColor = activity.priority === 'urgente' ? 'red' :
                                    activity.priority === 'alta' ? 'orange' :
                                    activity.priority === 'media' ? 'yellow' : 'gray';
                const priorityText = activity.priority === 'urgente' ? 'Urgente' :
                                   activity.priority === 'alta' ? 'Alta' :
                                   activity.priority === 'media' ? 'Media' : 'Baja';
                
                const activityCard = document.createElement('div');
                activityCard.className = 'border border-gray-200 rounded-lg p-4 mb-4 hover:shadow-md transition-shadow';
                activityCard.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1">
                            <div class="flex items-center space-x-2 mb-2">
                                <h4 class="font-semibold text-gray-800">${activity.title}</h4>
                                <span class="px-2 py-1 rounded-full text-xs font-medium bg-${priorityColor}-100 text-${priorityColor}-800">
                                    ${priorityText}
                                </span>
                            </div>
                            <p class="text-sm text-gray-600 mb-2">${activity.description}</p>
                            ${activity.notes ? `<p class="text-xs text-gray-500 italic">Notas: ${activity.notes}</p>` : ''}
                        </div>
                        <span class="px-2 py-1 rounded-full text-xs font-medium bg-${statusColor}-100 text-${statusColor}-800 ml-4">
                            ${statusText}
                        </span>
                    </div>
                    <div class="flex justify-between items-center text-sm text-gray-500">
                        <div class="flex items-center space-x-4 flex-wrap">
                            <span><i class="fas fa-user mr-1"></i>${assignedUser ? assignedUser.name : 'Sin asignar'}</span>
                            <span><i class="fas fa-calendar mr-1"></i>${activity.deadline || 'Sin fecha'}</span>
                            <span class="px-2 py-1 rounded-full text-xs ${
                                activity.program === 'software' ? 'bg-purple-100 text-purple-800' : 'bg-orange-100 text-orange-800'
                            }">
                                ${activity.program === 'software' ? 'Ing. Software' : 'Ing. Mecatr√≥nica'}
                            </span>
                            ${createdByUser ? `<span class="text-xs"><i class="fas fa-user-plus mr-1"></i>Por: ${createdByUser.name}</span>` : ''}
                        </div>
                        <div class="flex space-x-2">
                            ${activity.status !== 'completed' ? `
                                <button onclick="markAsCompleted('${activity.id}')" 
                                        class="text-green-600 hover:text-green-800 p-1">
                                    <i class="fas fa-check"></i>
                                </button>
                            ` : ''}
                            <button onclick="editActivity('${activity.id}')" 
                                    class="text-blue-600 hover:text-blue-800 p-1">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteActivity('${activity.id}')" 
                                    class="text-red-600 hover:text-red-800 p-1">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(activityCard);
            });
        }

        async function markAsCompleted(activityId) {
            try {
                await updateActivityStatus(activityId, 'completed');
                loadActivities();
                updateStats();
            } catch (error) {
                console.error('Error marking activity as completed:', error);
            }
        }

        function editActivity(activityId) {
            showNotification('Funci√≥n de edici√≥n disponible pr√≥ximamente', 'info');
        }

        async function deleteActivity(activityId) {
            if (confirm('¬øEst√° seguro de eliminar esta actividad?')) {
                try {
                    setLoadingState(true);
                    
                    activities = activities.filter(a => a.id !== activityId);
                    saveDataToStorage();
                    
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    loadActivities();
                    updateStats();
                    setLoadingState(false);
                    showNotification('Actividad eliminada permanentemente', 'success');
                } catch (error) {
                    setLoadingState(false);
                    showNotification('Error al eliminar actividad', 'error');
                }
            }
        }

        // Admin functions
        function clearAllData() {
            if (currentUser && currentUser.role === 'admin') {
                if (confirm('¬øEst√° seguro de eliminar TODOS los datos? Esta acci√≥n no se puede deshacer.')) {
                    if (confirm('CONFIRMACI√ìN FINAL: Se eliminar√°n todos los usuarios y actividades. ¬øContinuar?')) {
                        try {
                            localStorage.removeItem(STORAGE_KEYS.USERS);
                            localStorage.removeItem(STORAGE_KEYS.ACTIVITIES);
                            localStorage.removeItem(STORAGE_KEYS.CURRENT_USER);
                            localStorage.removeItem(STORAGE_KEYS.LAST_SYNC);
                            
                            users = [];
                            activities = [];
                            currentUser = null;
                            
                            createInitialData();
                            saveDataToStorage();
                            
                            logout();
                            
                            showNotification('Todos los datos han sido eliminados y reiniciados', 'success');
                        } catch (error) {
                            showNotification('Error al eliminar datos', 'error');
                        }
                    }
                }
            } else {
                showNotification('Solo el administrador puede eliminar todos los datos', 'error');
            }
        }

        function exportData() {
            if (currentUser && currentUser.role === 'admin') {
                try {
                    const exportData = {
                        users: users,
                        activities: activities,
                        exportDate: new Date().toISOString(),
                        exportedBy: currentUser.name,
                        sheetsConnected: sheetsConnected
                    };
                    
                    const dataStr = JSON.stringify(exportData, null, 2);
                    const dataBlob = new Blob([dataStr], {type: 'application/json'});
                    
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(dataBlob);
                    link.download = `itson_backup_${new Date().toISOString().split('T')[0]}.json`;
                    link.click();
                    
                    showNotification('Datos exportados exitosamente', 'success');
                } catch (error) {
                    showNotification('Error al exportar datos', 'error');
                }
            } else {
                showNotification('Solo el administrador puede exportar datos', 'error');
            }
        }

        function editUser(userId) {
            showNotification('Funci√≥n de edici√≥n disponible pr√≥ximamente', 'info');
        }

        async function deleteUser(userId) {
            if (confirm('¬øEst√° seguro de eliminar este usuario?')) {
                try {
                    setLoadingState(true);
                    
                    users = users.filter(u => u.id !== userId);
                    saveDataToStorage();
                    
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    loadUsers();
                    updateStats();
                    setLoadingState(false);
                    showNotification('Usuario eliminado permanentemente', 'success');
                } catch (error) {
                    setLoadingState(false);
                    showNotification('Error al eliminar usuario', 'error');
                }
            }
        }

        // Update statistics
        function updateStats() {
            const totalTeachers = users.filter(u => u.program !== 'admin').length;
            const softwareTeachers = users.filter(u => u.program === 'software').length;
            const mechatronicsTeachers = users.filter(u => u.program === 'mechatronics').length;
            const activeActivities = activities.filter(a => a.status !== 'completed').length;
            
            document.getElementById('totalTeachers').textContent = totalTeachers;
            document.getElementById('softwareTeachers').textContent = softwareTeachers;
            document.getElementById('mechatronicsTeachers').textContent = mechatronicsTeachers;
            document.getElementById('activeActivities').textContent = activeActivities;
            
            updateReportsStats();
            updateAdminPanel();
        }

        function updateReportsStats() {
            const completed = activities.filter(a => a.status === 'completed').length;
            const inProgress = activities.filter(a => a.status === 'in-progress').length;
            const pending = activities.filter(a => a.status === 'pending').length;
            
            document.getElementById('completedCount').textContent = completed;
            document.getElementById('inProgressCount').textContent = inProgress;
            document.getElementById('pendingCount').textContent = pending;
            
            const softwareActivities = activities.filter(a => a.program === 'software');
            const mechatronicsActivities = activities.filter(a => a.program === 'mechatronics');
            
            const softwareCompleted = softwareActivities.filter(a => a.status === 'completed').length;
            const mechatronicsCompleted = mechatronicsActivities.filter(a => a.status === 'completed').length;
            
            const softwareProgress = softwareActivities.length > 0 ? 
                Math.round((softwareCompleted / softwareActivities.length) * 100) : 0;
            const mechatronicsProgress = mechatronicsActivities.length > 0 ? 
                Math.round((mechatronicsCompleted / mechatronicsActivities.length) * 100) : 0;
            
            document.getElementById('softwareProgress').textContent = `${softwareProgress}%`;
            document.getElementById('mechatronicsProgress').textContent = `${mechatronicsProgress}%`;
            document.getElementById('softwareProgressBar').style.width = `${softwareProgress}%`;
            document.getElementById('mechatronicsProgressBar').style.width = `${mechatronicsProgress}%`;
        }

        function updateAdminPanel() {
            const lastSync = localStorage.getItem(STORAGE_KEYS.LAST_SYNC);
            if (lastSync) {
                const date = new Date(lastSync);
                document.getElementById('lastUpdateTime').textContent = date.toLocaleString('es-MX');
            }
            
            const totalRecords = users.length + activities.length;
            document.getElementById('totalRecords').textContent = `${totalRecords} registros`;
            
            const adminPanel = document.getElementById('adminPanel');
            if (currentUser && currentUser.role === 'admin') {
                adminPanel.style.display = 'block';
            } else {
                adminPanel.style.display = 'none';
            }
        }

        function showDataSummary() {
            if (currentUser && currentUser.role === 'admin') {
                const summary = {
                    totalUsers: users.length,
                    totalActivities: activities.length,
                    usersByProgram: {
                        software: users.filter(u => u.program === 'software').length,
                        mechatronics: users.filter(u => u.program === 'mechatronics').length,
                        admin: users.filter(u => u.program === 'admin').length
                    },
                    activitiesByStatus: {
                        completed: activities.filter(a => a.status === 'completed').length,
                        inProgress: activities.filter(a => a.status === 'in-progress').length,
                        pending: activities.filter(a => a.status === 'pending').length
                    },
                    activitiesByProgram: {
                        software: activities.filter(a => a.program === 'software').length,
                        mechatronics: activities.filter(a => a.program === 'mechatronics').length
                    }
                };
                
                const summaryText = `
üìä RESUMEN DETALLADO DEL SISTEMA

üîó CONEXI√ìN:
‚Ä¢ Google Sheets: ${sheetsConnected ? 'Conectado ‚úÖ' : 'Desconectado ‚ùå'}
‚Ä¢ Almacenamiento: Local permanente ‚úÖ

üë• USUARIOS:
‚Ä¢ Total: ${summary.totalUsers}
‚Ä¢ Ing. Software: ${summary.usersByProgram.software}
‚Ä¢ Ing. Mecatr√≥nica: ${summary.usersByProgram.mechatronics}
‚Ä¢ Administradores: ${summary.usersByProgram.admin}

üìã ACTIVIDADES:
‚Ä¢ Total: ${summary.totalActivities}
‚Ä¢ Completadas: ${summary.activitiesByStatus.completed}
‚Ä¢ En Progreso: ${summary.activitiesByStatus.inProgress}
‚Ä¢ Pendientes: ${summary.activitiesByStatus.pending}

üìö POR PROGRAMA:
‚Ä¢ Software: ${summary.activitiesByProgram.software} actividades
‚Ä¢ Mecatr√≥nica: ${summary.activitiesByProgram.mechatronics} actividades

üíæ ALMACENAMIENTO:
‚Ä¢ Datos guardados localmente: ‚úÖ
‚Ä¢ Sincronizaci√≥n con Sheets: ${sheetsConnected ? 'Activa' : 'Manual'}
‚Ä¢ √öltima actualizaci√≥n: ${new Date().toLocaleString('es-MX')}
                `;
                
                alert(summaryText);
            } else {
                showNotification('Solo el administrador puede ver el resumen detallado', 'error');
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('newActivityDeadline').setAttribute('min', today);
            
            if (!checkExistingSession()) {
                // Show initial loading state
                updateSyncStatus('Sistema iniciando...', 'loading');
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'975fa7cdd0e45257',t:'MTc1NjM0MDU1OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>

