<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EduControl Pro - Tablero Docente Académico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap");
      body {
        font-family: "Inter", sans-serif;
      }
      .gradient-bg {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }
      .gradient-software {
        background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
      }
      .gradient-mecatronica {
        background: linear-gradient(135deg, #059669 0%, #0d9488 100%);
      }
      .card-shadow {
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      }
      .notification-enter {
        animation: slideInRight 0.3s ease-out;
      }
      @keyframes slideInRight {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      .fade-in {
        animation: fadeIn 0.5s ease-in;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .career-badge-software {
        @apply bg-indigo-100 text-indigo-800;
      }
      .career-badge-mecatronica {
        @apply bg-emerald-100 text-emerald-800;
      }
      .data-structure-comment {
        color: #10b981;
        font-style: italic;
      }
      .loading-overlay {
        background: rgba(0, 0, 0, 0.5);
      }
    </style>
  </head>
  <body class="bg-gray-50">
    <!-- 
    ESTRUCTURA DE BASE DE DATOS GOOGLE SHEETS
    ==========================================
    
    CARRERA: INGENIERÍA EN SOFTWARE (ID: 11DL5I9Zcxm-SdQ9cXRAO-j_InMYHs36qZOk6QRIVMKI)
    Hoja 1 - Usuario: ID | Email | Rol | Nombre | Password | Fecha Registro | Estado | Telefono | Especialidad
    Hoja 2 - Actividades: ID | Título | Descripción | Fecha Límite | Prioridad | Estado | Asignado a | Creado por | Fecha Creación | Fecha Completado | Notas
    Hoja 3 - Progreso: Fecha | Período Inicio | Período Fin | Total Actividades | Completadas | Total Docentes | Generado por
    Hoja 4 - Docentes: ID | Nombre | Email | Especialidad | Teléfono | Estado | Fecha Registro | Notas
    
    CARRERA: INGENIERÍA EN MECATRÓNICA Y MANUFACTURA (ID: 1hO1kMdw7LDlXePyjJRj4d4dd-v7cQ1dm8TCkU7izqR8)
    Hoja 1 - Usuario: ID | Email | Rol | Nombre | Password | Fecha Registro | Estado | Telefono | Especialidad
    Hoja 2 - Actividades: ID | Título | Descripción | Fecha Límite | Prioridad | Estado | Asignado a | Creado por | Fecha Creación | Fecha Completado | Notas
    Hoja 3 - Progreso: Fecha | Período Inicio | Período Fin | Total Actividades | Completadas | Total Docentes | Generado por
    Hoja 4 - Docentes: ID | Nombre | Email | Especialidad | Teléfono | Estado | Fecha Registro | Notas
    -->

    <!-- Contenedor de Notificaciones -->
    <div id="notifications" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <!-- Indicador de Carga -->
    <div
      id="loadingIndicator"
      class="hidden fixed top-4 left-1/2 transform -translate-x-1/2 bg-blue-600 text-white px-4 py-2 rounded-lg shadow-lg z-50"
    >
      <i class="fas fa-spinner fa-spin mr-2"></i>Sincronizando con Google
      Sheets...
    </div>

    <!-- Pantalla de Login -->
    <div
      id="loginScreen"
      class="min-h-screen gradient-bg flex items-center justify-center p-4"
    >
      <div class="bg-white rounded-2xl card-shadow p-8 w-full max-w-md fade-in">
        <div class="text-center mb-8">
          <div
            class="w-16 h-16 bg-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4"
          >
            <i class="fas fa-graduation-cap text-white text-2xl"></i>
          </div>
          <h1 class="text-3xl font-bold text-gray-800">EduControl Pro</h1>
          <p class="text-gray-600 mt-2">Tablero Docente Académico</p>
          <p class="text-sm text-gray-500 mt-1">
            Sistema Multi-Carrera con Google Sheets
          </p>
        </div>

        <form id="loginForm" class="space-y-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Carrera</label
            >
            <select
              id="career"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
              required
            >
              <option value="">Seleccionar carrera</option>
              <option value="software">Ingeniería en Software</option>
              <option value="mecatronica">
                Ingeniería en Mecatrónica y Manufactura
              </option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Email</label
            >
            <input
              type="email"
              id="email"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
              placeholder="Ingresa tu email"
              required
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Contraseña</label
            >
            <input
              type="password"
              id="password"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
              placeholder="Ingresa tu contraseña"
              required
            />
          </div>

          <button
            type="submit"
            class="w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition duration-200 font-medium"
          >
            Iniciar Sesión
          </button>
        </form>

        <div class="mt-6 text-center">
          <button
            id="resetPasswordBtn"
            class="text-indigo-600 hover:text-indigo-800 text-sm"
          >
            ¿Olvidaste tu contraseña?
          </button>
        </div>

        <!-- Usuarios de prueba -->
        <div class="mt-8 p-4 bg-gray-50 rounded-lg">
          <p class="text-xs text-gray-600 mb-2">
            Usuarios de prueba (ambas carreras):
          </p>
          <div class="text-xs space-y-1">
            <p><strong>Admin:</strong> admin@edu.com / admin123</p>
            <p><strong>Profesor:</strong> profesor@edu.com / prof123</p>
            <p><strong>Docente:</strong> docente@edu.com / doc123</p>
          </div>
          <p class="text-xs text-green-600 mt-2">
            ✅ Datos almacenados en Google Sheets
          </p>
        </div>
      </div>
    </div>

    <!-- Dashboard Principal -->
    <div id="dashboard" class="hidden min-h-screen bg-gray-50">
      <!-- Header -->
      <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="flex items-center justify-between px-6 py-4">
          <div class="flex items-center space-x-4">
            <div
              id="headerCareerIcon"
              class="w-10 h-10 bg-indigo-600 rounded-full flex items-center justify-center"
            >
              <i class="fas fa-graduation-cap text-white"></i>
            </div>
            <div>
              <h1 class="text-xl font-semibold text-gray-800">
                EduControl Pro
              </h1>
              <p id="headerCareerName" class="text-sm text-gray-600">Carrera</p>
            </div>
          </div>

          <div class="flex items-center space-x-4">
            <!-- Selector de Carrera (Solo Admin) -->
            <div id="careerSelector" class="hidden">
              <select
                id="switchCareer"
                class="px-3 py-2 border border-gray-300 rounded-lg text-sm"
              >
                <option value="software">Ing. Software</option>
                <option value="mecatronica">Ing. Mecatrónica</option>
              </select>
            </div>

            <!-- Estado de Conexión -->
            <div id="connectionStatus" class="flex items-center space-x-2">
              <div
                class="w-3 h-3 bg-green-500 rounded-full animate-pulse"
              ></div>
              <span class="text-xs text-gray-600">Google Sheets</span>
            </div>

            <!-- Notificaciones -->
            <button
              id="notificationBtn"
              class="relative p-2 text-gray-600 hover:text-gray-800"
            >
              <i class="fas fa-bell text-xl"></i>
              <span
                id="notificationBadge"
                class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center"
                >2</span
              >
            </button>

            <!-- Perfil -->
            <div class="flex items-center space-x-3">
              <img
                id="headerProfileImg"
                src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 40 40'%3E%3Ccircle cx='20' cy='20' r='20' fill='%23e5e7eb'/%3E%3Cpath d='M20 20c3.3 0 6-2.7 6-6s-2.7-6-6-6-6 2.7-6 6 2.7 6 6 6zm0 2c-4 0-12 2-12 6v2h24v-2c0-4-8-6-12-6z' fill='%236b7280'/%3E%3C/svg%3E"
                alt="Perfil"
                class="w-10 h-10 rounded-full"
              />
              <div>
                <p
                  id="headerUserName"
                  class="text-sm font-medium text-gray-800"
                >
                  Usuario
                </p>
                <p id="headerUserRole" class="text-xs text-gray-600">Rol</p>
              </div>
            </div>

            <button id="logoutBtn" class="text-gray-600 hover:text-gray-800">
              <i class="fas fa-sign-out-alt text-xl"></i>
            </button>
          </div>
        </div>
      </header>

      <div class="flex">
        <!-- Sidebar -->
        <aside class="w-64 bg-white shadow-sm min-h-screen">
          <nav class="p-6">
            <ul id="sidebarMenu" class="space-y-2">
              <!-- El menú se genera dinámicamente según el rol -->
            </ul>
          </nav>
        </aside>

        <!-- Contenido Principal -->
        <main class="flex-1 p-6">
          <!-- Dashboard Overview -->
          <div id="overviewSection" class="fade-in">
            <div class="mb-6">
              <h2 class="text-2xl font-bold text-gray-800">Panel de Control</h2>
              <p class="text-gray-600">Bienvenido a tu tablero académico</p>
              <div id="currentCareerBadge" class="mt-2">
                <!-- Badge de carrera actual -->
              </div>
            </div>

            <!-- Estadísticas -->
            <div
              id="statsCards"
              class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8"
            >
              <!-- Las tarjetas se generan dinámicamente -->
            </div>

            <!-- Gráficos y Actividad Reciente -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div class="bg-white rounded-xl card-shadow p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">
                  Progreso Mensual
                </h3>
                <div
                  class="h-64 flex items-center justify-center bg-gray-50 rounded-lg"
                >
                  <div class="text-center">
                    <i
                      class="fas fa-chart-line text-4xl text-gray-400 mb-2"
                    ></i>
                    <p class="text-gray-600">Gráfico de progreso</p>
                    <p class="text-xs text-gray-500 mt-2">
                      Datos sincronizados con Google Sheets
                    </p>
                  </div>
                </div>
              </div>

              <div class="bg-white rounded-xl card-shadow p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">
                  Actividad Reciente
                </h3>
                <div id="recentActivity" class="space-y-3">
                  <!-- Actividades recientes se generan dinámicamente -->
                </div>
              </div>
            </div>
          </div>

          <!-- Gestión de Usuarios -->
          <div id="usersSection" class="hidden fade-in">
            <div class="flex justify-between items-center mb-6">
              <div>
                <h2 class="text-2xl font-bold text-gray-800">
                  Gestión de Usuarios
                </h2>
                <p class="text-gray-600">Administra usuarios del sistema</p>
              </div>
              <button
                id="addUserBtn"
                class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition duration-200"
              >
                <i class="fas fa-plus mr-2"></i>Agregar Usuario
              </button>
            </div>

            <div class="bg-white rounded-xl card-shadow overflow-hidden">
              <div class="overflow-x-auto">
                <table class="w-full">
                  <thead class="bg-gray-50">
                    <tr>
                      <th
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                      >
                        ID
                      </th>
                      <th
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                      >
                        Usuario
                      </th>
                      <th
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                      >
                        Email
                      </th>
                      <th
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                      >
                        Rol
                      </th>
                      <th
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                      >
                        Estado
                      </th>
                      <th
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                      >
                        Fecha Registro
                      </th>
                      <th
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                      >
                        Acciones
                      </th>
                    </tr>
                  </thead>
                  <tbody
                    id="usersTable"
                    class="bg-white divide-y divide-gray-200"
                  >
                    <!-- Usuarios se generan dinámicamente -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Gestión de Actividades -->
          <div id="activitiesSection" class="hidden fade-in">
            <div class="flex justify-between items-center mb-6">
              <div>
                <h2 class="text-2xl font-bold text-gray-800">
                  Gestión de Actividades
                </h2>
                <p class="text-gray-600">
                  Administra las actividades académicas
                </p>
              </div>
              <button
                id="addActivityBtn"
                class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200"
              >
                <i class="fas fa-plus mr-2"></i>Nueva Actividad
              </button>
            </div>

            <div
              class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
              id="activitiesGrid"
            >
              <!-- Actividades se generan dinámicamente -->
            </div>
          </div>

          <!-- Gestión de Docentes -->
          <div id="teachersSection" class="hidden fade-in">
            <div class="flex justify-between items-center mb-6">
              <div>
                <h2 class="text-2xl font-bold text-gray-800">
                  Gestión de Docentes
                </h2>
                <p class="text-gray-600">Administra el personal docente</p>
              </div>
              <button
                id="addTeacherBtn"
                class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200"
              >
                <i class="fas fa-plus mr-2"></i>Agregar Docente
              </button>
            </div>

            <div class="bg-white rounded-xl card-shadow overflow-hidden">
              <div class="overflow-x-auto">
                <table class="w-full">
                  <thead class="bg-gray-50">
                    <tr>
                      <th
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                      >
                        ID
                      </th>
                      <th
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                      >
                        Nombre
                      </th>
                      <th
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                      >
                        Email
                      </th>
                      <th
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                      >
                        Especialidad
                      </th>
                      <th
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                      >
                        Teléfono
                      </th>
                      <th
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                      >
                        Estado
                      </th>
                      <th
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                      >
                        Acciones
                      </th>
                    </tr>
                  </thead>
                  <tbody
                    id="teachersTable"
                    class="bg-white divide-y divide-gray-200"
                  >
                    <!-- Docentes se generan dinámicamente -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Reportes -->
          <div id="reportsSection" class="hidden fade-in">
            <div class="mb-6">
              <h2 class="text-2xl font-bold text-gray-800">
                Reportes y Análisis
              </h2>
              <p class="text-gray-600">
                Genera reportes detallados del progreso académico
              </p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
              <div class="bg-white rounded-xl card-shadow p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">
                  Reportes Individuales
                </h3>
                <div class="space-y-4">
                  <select
                    id="userSelect"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg"
                  >
                    <option value="">Seleccionar usuario</option>
                  </select>
                  <button
                    id="generateIndividualReport"
                    class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition duration-200"
                  >
                    <i class="fas fa-file-pdf mr-2"></i>Generar Reporte
                    Individual
                  </button>
                </div>
              </div>

              <div class="bg-white rounded-xl card-shadow p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">
                  Reporte General
                </h3>
                <div class="space-y-4">
                  <div class="flex space-x-2">
                    <input
                      type="date"
                      id="startDate"
                      class="flex-1 px-4 py-2 border border-gray-300 rounded-lg"
                    />
                    <input
                      type="date"
                      id="endDate"
                      class="flex-1 px-4 py-2 border border-gray-300 rounded-lg"
                    />
                  </div>
                  <button
                    id="generateGeneralReport"
                    class="w-full bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700 transition duration-200"
                  >
                    <i class="fas fa-file-pdf mr-2"></i>Generar Reporte General
                  </button>
                </div>
              </div>
            </div>

            <!-- Progreso Histórico -->
            <div class="bg-white rounded-xl card-shadow p-6">
              <h3 class="text-lg font-semibold text-gray-800 mb-4">
                Progreso Histórico
              </h3>
              <div id="progressHistory" class="overflow-x-auto">
                <table class="w-full">
                  <thead class="bg-gray-50">
                    <tr>
                      <th
                        class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase"
                      >
                        Fecha
                      </th>
                      <th
                        class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase"
                      >
                        Período
                      </th>
                      <th
                        class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase"
                      >
                        Total Actividades
                      </th>
                      <th
                        class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase"
                      >
                        Completadas
                      </th>
                      <th
                        class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase"
                      >
                        Total Docentes
                      </th>
                      <th
                        class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase"
                      >
                        Generado por
                      </th>
                    </tr>
                  </thead>
                  <tbody id="progressHistoryTable">
                    <!-- Datos de progreso histórico -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Perfil -->
          <div id="profileSection" class="hidden fade-in">
            <div class="mb-6">
              <h2 class="text-2xl font-bold text-gray-800">Mi Perfil</h2>
              <p class="text-gray-600">Gestiona tu información personal</p>
            </div>

            <div class="bg-white rounded-xl card-shadow p-6">
              <div class="flex items-center space-x-6 mb-6">
                <div class="relative">
                  <img
                    id="profileImg"
                    src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23e5e7eb'/%3E%3Cpath d='M50 50c8.25 0 15-6.75 15-15s-6.75-15-15-15-15 6.75-15 15 6.75 15 15 15zm0 5c-10 0-30 5-30 15v5h60v-5c0-10-20-15-30-15z' fill='%236b7280'/%3E%3C/svg%3E"
                    alt="Foto de perfil"
                    class="w-24 h-24 rounded-full"
                  />
                  <button
                    id="changePhotoBtn"
                    class="absolute bottom-0 right-0 bg-indigo-600 text-white p-2 rounded-full hover:bg-indigo-700 transition duration-200"
                  >
                    <i class="fas fa-camera text-sm"></i>
                  </button>
                </div>
                <div>
                  <h3
                    id="profileName"
                    class="text-xl font-semibold text-gray-800"
                  >
                    Nombre Usuario
                  </h3>
                  <p id="profileRole" class="text-gray-600">Rol del Usuario</p>
                  <p id="profileEmail" class="text-gray-500">
                    email@ejemplo.com
                  </p>
                  <div id="profileCareerBadge" class="mt-2">
                    <!-- Badge de carrera -->
                  </div>
                </div>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2"
                    >Nombre Completo</label
                  >
                  <input
                    type="text"
                    id="fullName"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg"
                  />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2"
                    >Email</label
                  >
                  <input
                    type="email"
                    id="emailProfile"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg"
                  />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2"
                    >Teléfono</label
                  >
                  <input
                    type="tel"
                    id="phone"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg"
                  />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2"
                    >Especialidad</label
                  >
                  <input
                    type="text"
                    id="specialty"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg"
                  />
                </div>
              </div>

              <div class="mt-6 flex space-x-4">
                <button
                  id="saveProfileBtn"
                  class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition duration-200"
                >
                  <i class="fas fa-save mr-2"></i>Guardar Cambios
                </button>
                <button
                  id="changePasswordBtn"
                  class="bg-orange-600 text-white px-6 py-2 rounded-lg hover:bg-orange-700 transition duration-200"
                >
                  <i class="fas fa-key mr-2"></i>Cambiar Contraseña
                </button>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <!-- Modal para Agregar/Editar Usuario -->
    <div
      id="userModal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
    >
      <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
        <div class="flex justify-between items-center mb-4">
          <h3 id="userModalTitle" class="text-lg font-semibold text-gray-800">
            Agregar Usuario
          </h3>
          <button id="closeUserModal" class="text-gray-500 hover:text-gray-700">
            <i class="fas fa-times"></i>
          </button>
        </div>

        <form id="userForm" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >Nombre Completo</label
            >
            <input
              type="text"
              id="modalUserName"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg"
              required
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >Email</label
            >
            <input
              type="email"
              id="modalUserEmail"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg"
              required
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >Rol</label
            >
            <select
              id="modalUserRole"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg"
              required
            >
              <option value="">Seleccionar rol</option>
              <option value="administrador">Administrador</option>
              <option value="profesor">Profesor Auxiliar</option>
              <option value="docente">Docente</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >Contraseña</label
            >
            <input
              type="password"
              id="modalUserPassword"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg"
              required
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >Teléfono</label
            >
            <input
              type="tel"
              id="modalUserPhone"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >Especialidad</label
            >
            <input
              type="text"
              id="modalUserSpecialty"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg"
            />
          </div>

          <div class="flex space-x-3 pt-4">
            <button
              type="submit"
              class="flex-1 bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition duration-200"
            >
              Guardar
            </button>
            <button
              type="button"
              id="cancelUserModal"
              class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition duration-200"
            >
              Cancelar
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal para Actividades -->
    <div
      id="activityModal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
    >
      <div class="bg-white rounded-xl p-6 w-full max-w-lg mx-4">
        <div class="flex justify-between items-center mb-4">
          <h3
            id="activityModalTitle"
            class="text-lg font-semibold text-gray-800"
          >
            Nueva Actividad
          </h3>
          <button
            id="closeActivityModal"
            class="text-gray-500 hover:text-gray-700"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>

        <form id="activityForm" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >Título</label
            >
            <input
              type="text"
              id="modalActivityTitle"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg"
              required
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >Descripción</label
            >
            <textarea
              id="modalActivityDescription"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg h-24"
              required
            ></textarea>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >Fecha Límite</label
            >
            <input
              type="date"
              id="modalActivityDeadline"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg"
              required
            />
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1"
                >Prioridad</label
              >
              <select
                id="modalActivityPriority"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                required
              >
                <option value="baja">Baja</option>
                <option value="media">Media</option>
                <option value="alta">Alta</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1"
                >Estado</label
              >
              <select
                id="modalActivityStatus"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                required
              >
                <option value="pendiente">Pendiente</option>
                <option value="en_progreso">En Progreso</option>
                <option value="completada">Completada</option>
              </select>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >Asignar a</label
            >
            <select
              id="modalActivityAssignee"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg"
              required
            >
              <option value="">Seleccionar usuario</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >Notas</label
            >
            <textarea
              id="modalActivityNotes"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg h-20"
              placeholder="Notas adicionales (opcional)"
            ></textarea>
          </div>

          <div class="flex space-x-3 pt-4">
            <button
              type="submit"
              class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition duration-200"
            >
              Guardar
            </button>
            <button
              type="button"
              id="cancelActivityModal"
              class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition duration-200"
            >
              Cancelar
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal para Docentes -->
    <div
      id="teacherModal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
    >
      <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
        <div class="flex justify-between items-center mb-4">
          <h3
            id="teacherModalTitle"
            class="text-lg font-semibold text-gray-800"
          >
            Agregar Docente
          </h3>
          <button
            id="closeTeacherModal"
            class="text-gray-500 hover:text-gray-700"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>

        <form id="teacherForm" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >Nombre Completo</label
            >
            <input
              type="text"
              id="modalTeacherName"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg"
              required
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >Email</label
            >
            <input
              type="email"
              id="modalTeacherEmail"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg"
              required
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >Especialidad</label
            >
            <input
              type="text"
              id="modalTeacherSpecialty"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg"
              required
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >Teléfono</label
            >
            <input
              type="tel"
              id="modalTeacherPhone"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg"
              required
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >Estado</label
            >
            <select
              id="modalTeacherStatus"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg"
              required
            >
              <option value="activo">Activo</option>
              <option value="inactivo">Inactivo</option>
              <option value="licencia">En Licencia</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >Notas</label
            >
            <textarea
              id="modalTeacherNotes"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg h-20"
              placeholder="Notas adicionales (opcional)"
            ></textarea>
          </div>

          <div class="flex space-x-3 pt-4">
            <button
              type="submit"
              class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition duration-200"
            >
              Guardar
            </button>
            <button
              type="button"
              id="cancelTeacherModal"
              class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition duration-200"
            >
              Cancelar
            </button>
          </div>
        </form>
      </div>
    </div>

    <script>
      // CONEXIÓN CON GOOGLE SHEETS - DATOS REALES
      // ==========================================

      // ⚠️ IMPORTANTE: Reemplaza esta URL con la URL de tu Google Apps Script Web App
      const GOOGLE_SCRIPT_URL =
        "https://script.google.com/macros/s/AKfycbzKpSYn6PB2V7gVkNPFx0vjXJ_OfhHKqp9rJcdPmXNvmtsICxODUpse_O_nWFVLr8yRwg/exec";

      let currentUser = null;
      let currentCareer = "software"; // Por defecto
      let cachedData = {
        software: { users: [], activities: [], teachers: [], progress: [] },
        mecatronica: { users: [], activities: [], teachers: [], progress: [] },
      };

      let notifications = [
        {
          id: 1,
          message: "Sistema conectado con Google Sheets",
          type: "success",
          timestamp: new Date(),
        },
        {
          id: 2,
          message: "Datos sincronizados en tiempo real",
          type: "info",
          timestamp: new Date(),
        },
      ];

      // ============================================================================
      // FUNCIONES DE COMUNICACIÓN CON GOOGLE APPS SCRIPT
      // ============================================================================

      /**
       * Realiza peticiones al Google Apps Script
       */
      async function callGoogleScript(
        action,
        type = null,
        payload = null,
        userId = null
      ) {
        try {
          if (
            GOOGLE_SCRIPT_URL ===
            "https://script.google.com/macros/s/AKfycbzKpSYn6PB2V7gVkNPFx0vjXJ_OfhHKqp9rJcdPmXNvmtsICxODUpse_O_nWFVLr8yRwg/exec"
          ) {
            throw new Error(
              "⚠️ Debes configurar la URL de tu Google Apps Script en la línea 49"
            );
          }

          showLoadingIndicator(true);

          const requestData = {
            action,
            career: currentCareer,
            type,
            payload,
            userId,
          };

          const response = await fetch(GOOGLE_SCRIPT_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(requestData),
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const result = await response.json();

          if (!result.success) {
            throw new Error(result.error || "Error desconocido");
          }

          return result;
        } catch (error) {
          console.error("Error en comunicación con Google Script:", error);
          showNotification(`Error: ${error.message}`, "error");
          throw error;
        } finally {
          showLoadingIndicator(false);
        }
      }

      /**
       * Autentica usuario con Google Sheets
       */
      async function authenticateUser(career, email, password) {
        try {
          const result = await callGoogleScript("login", null, {
            email,
            password,
          });
          return result.user;
        } catch (error) {
          return null;
        }
      }

      /**
       * Obtiene datos de Google Sheets
       */
      async function fetchData(type, userId = null) {
        try {
          const result = await callGoogleScript("get", type, null, userId);
          cachedData[currentCareer][type] = result.data;
          return result.data;
        } catch (error) {
          // Si hay error, usar datos en caché si existen
          return cachedData[currentCareer][type] || [];
        }
      }

      /**
       * Crea nuevo registro en Google Sheets
       */
      async function createRecord(type, data) {
        try {
          const result = await callGoogleScript("create", type, data);
          // Actualizar caché local
          await fetchData(type);
          return result.data;
        } catch (error) {
          throw error;
        }
      }

      /**
       * Actualiza registro en Google Sheets
       */
      async function updateRecord(type, data) {
        try {
          const result = await callGoogleScript("update", type, data);
          // Actualizar caché local
          await fetchData(type);
          return result.data;
        } catch (error) {
          throw error;
        }
      }

      /**
       * Elimina registro de Google Sheets
       */
      async function deleteRecord(type, id) {
        try {
          await callGoogleScript("delete", type, { id });
          // Actualizar caché local
          await fetchData(type);
          return true;
        } catch (error) {
          throw error;
        }
      }

      /**
       * Genera reporte en Google Sheets
       */
      async function generateReport(reportData) {
        try {
          const result = await callGoogleScript(
            "generateReport",
            null,
            reportData
          );
          // Actualizar datos de progreso
          await fetchData("progress");
          return result.data;
        } catch (error) {
          throw error;
        }
      }

      /**
       * Muestra/oculta indicador de carga
       */
      function showLoadingIndicator(show) {
        const indicator = document.getElementById("loadingIndicator");
        indicator.style.display = show ? "block" : "none";
      }

      // Funciones de utilidad
      function showNotification(message, type = "info") {
        const notification = document.createElement("div");
        notification.className = `notification-enter bg-white border-l-4 ${
          type === "success"
            ? "border-green-500"
            : type === "error"
            ? "border-red-500"
            : type === "warning"
            ? "border-yellow-500"
            : "border-blue-500"
        } p-4 rounded-lg shadow-lg mb-2`;

        notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas ${
                      type === "success"
                        ? "fa-check-circle text-green-500"
                        : type === "error"
                        ? "fa-exclamation-circle text-red-500"
                        : type === "warning"
                        ? "fa-exclamation-triangle text-yellow-500"
                        : "fa-info-circle text-blue-500"
                    } mr-3"></i>
                    <span class="text-gray-800">${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-auto text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;

        document.getElementById("notifications").appendChild(notification);

        setTimeout(() => {
          if (notification.parentElement) {
            notification.remove();
          }
        }, 5000);
      }

      function hasPermission(action) {
        if (!currentUser) return false;

        const permissions = {
          administrador: [
            "manage_users",
            "manage_activities",
            "manage_teachers",
            "view_reports",
            "generate_reports",
            "manage_profile",
            "switch_career",
          ],
          profesor: [
            "manage_activities",
            "manage_teachers",
            "view_reports",
            "generate_reports",
            "manage_profile",
          ],
          docente: ["view_own_activities", "manage_profile", "reset_password"],
        };

        return permissions[currentUser.rol]?.includes(action) || false;
      }

      function getCurrentData() {
        return cachedData[currentCareer];
      }

      function updateCareerUI() {
        const careerNames = {
          software: "Ingeniería en Software",
          mecatronica: "Ingeniería en Mecatrónica y Manufactura",
        };

        const careerColors = {
          software: "gradient-software",
          mecatronica: "gradient-mecatronica",
        };

        const careerIcons = {
          software: "fa-code",
          mecatronica: "fa-cogs",
        };

        // Actualizar header
        document.getElementById("headerCareerName").textContent =
          careerNames[currentCareer];
        const headerIcon = document.getElementById("headerCareerIcon");
        headerIcon.className = `w-10 h-10 ${
          currentCareer === "software" ? "bg-indigo-600" : "bg-emerald-600"
        } rounded-full flex items-center justify-center`;
        headerIcon.innerHTML = `<i class="fas ${careerIcons[currentCareer]} text-white"></i>`;

        // Actualizar badge en overview
        const currentCareerBadge =
          document.getElementById("currentCareerBadge");
        currentCareerBadge.innerHTML = `
                <span class="px-3 py-1 text-sm font-medium rounded-full ${
                  currentCareer === "software"
                    ? "career-badge-software"
                    : "career-badge-mecatronica"
                }">
                    <i class="fas ${careerIcons[currentCareer]} mr-2"></i>${
          careerNames[currentCareer]
        }
                </span>
            `;

        // Actualizar selector de carrera
        document.getElementById("switchCareer").value = currentCareer;
      }

      function generateMenu() {
        const menu = document.getElementById("sidebarMenu");
        menu.innerHTML = "";

        const menuItems = [
          {
            id: "overview",
            icon: "fa-tachometer-alt",
            text: "Panel Principal",
            permission: true,
          },
          {
            id: "users",
            icon: "fa-users",
            text: "Gestión de Usuarios",
            permission: hasPermission("manage_users"),
          },
          {
            id: "activities",
            icon: "fa-tasks",
            text: "Actividades",
            permission:
              hasPermission("manage_activities") ||
              hasPermission("view_own_activities"),
          },
          {
            id: "teachers",
            icon: "fa-chalkboard-teacher",
            text: "Gestión de Docentes",
            permission: hasPermission("manage_teachers"),
          },
          {
            id: "reports",
            icon: "fa-chart-bar",
            text: "Reportes",
            permission: hasPermission("view_reports"),
          },
          {
            id: "profile",
            icon: "fa-user",
            text: "Mi Perfil",
            permission: hasPermission("manage_profile"),
          },
        ];

        menuItems.forEach((item) => {
          if (item.permission) {
            const li = document.createElement("li");
            li.innerHTML = `
                        <button onclick="showSection('${item.id}')" class="w-full flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 rounded-lg transition duration-200">
                            <i class="fas ${item.icon}"></i>
                            <span>${item.text}</span>
                        </button>
                    `;
            menu.appendChild(li);
          }
        });
      }

      function showSection(sectionId) {
        // Ocultar todas las secciones
        const sections = [
          "overviewSection",
          "usersSection",
          "activitiesSection",
          "teachersSection",
          "reportsSection",
          "profileSection",
        ];
        sections.forEach((id) => {
          document.getElementById(id).classList.add("hidden");
        });

        // Mostrar la sección seleccionada
        document
          .getElementById(sectionId + "Section")
          .classList.remove("hidden");

        // Cargar contenido específico
        switch (sectionId) {
          case "overview":
            loadOverview();
            break;
          case "users":
            loadUsers();
            break;
          case "activities":
            loadActivities();
            break;
          case "teachers":
            loadTeachers();
            break;
          case "reports":
            loadReports();
            break;
          case "profile":
            loadProfile();
            break;
        }
      }

      async function loadOverview() {
        try {
          // Cargar todos los datos necesarios
          const [users, activities, teachers] = await Promise.all([
            fetchData("users"),
            fetchData("activities"),
            fetchData("teachers"),
          ]);

          // Cargar estadísticas
          const statsCards = document.getElementById("statsCards");
          const stats = [
            {
              title: "Total Usuarios",
              value: users.length,
              icon: "fa-users",
              color: "bg-blue-500",
            },
            {
              title: "Actividades Activas",
              value: activities.filter(
                (a) => a.estado === "pendiente" || a.estado === "en_progreso"
              ).length,
              icon: "fa-tasks",
              color: "bg-green-500",
            },
            {
              title: "Docentes Registrados",
              value: teachers.length,
              icon: "fa-chalkboard-teacher",
              color: "bg-purple-500",
            },
            {
              title: "Completadas",
              value: activities.filter((a) => a.estado === "completada").length,
              icon: "fa-check-circle",
              color: "bg-orange-500",
            },
          ];

          statsCards.innerHTML = stats
            .map(
              (stat) => `
                    <div class="bg-white rounded-xl card-shadow p-6">
                        <div class="flex items-center">
                            <div class="w-12 h-12 ${stat.color} rounded-lg flex items-center justify-center">
                                <i class="fas ${stat.icon} text-white text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">${stat.title}</p>
                                <p class="text-2xl font-bold text-gray-900">${stat.value}</p>
                            </div>
                        </div>
                    </div>
                `
            )
            .join("");

          // Cargar actividad reciente
          const recentActivity = document.getElementById("recentActivity");
          const recentActivities = activities.slice(-5).reverse();

          recentActivity.innerHTML = recentActivities
            .map((activity) => {
              const user = users.find((u) => u.id === activity.asignadoA);
              return `
                        <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg">
                            <div class="w-8 h-8 bg-indigo-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-tasks text-indigo-600 text-sm"></i>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-gray-800">${
                                  activity.titulo
                                }</p>
                                <p class="text-xs text-gray-600">Asignado a: ${
                                  user?.nombre || "Usuario desconocido"
                                }</p>
                            </div>
                            <span class="text-xs px-2 py-1 rounded-full ${
                              activity.estado === "completada"
                                ? "bg-green-100 text-green-800"
                                : activity.estado === "en_progreso"
                                ? "bg-blue-100 text-blue-800"
                                : "bg-yellow-100 text-yellow-800"
                            }">${activity.estado.replace("_", " ")}</span>
                        </div>
                    `;
            })
            .join("");
        } catch (error) {
          showNotification("Error al cargar el panel principal", "error");
        }
      }

      async function loadUsers() {
        if (!hasPermission("manage_users")) {
          showNotification("No tienes permisos para ver esta sección", "error");
          return;
        }

        try {
          const users = await fetchData("users");
          const usersTable = document.getElementById("usersTable");
          let filteredUsers = users;

          // Si es profesor auxiliar, solo puede ver docentes y otros profesores
          if (currentUser.rol === "profesor") {
            filteredUsers = users.filter(
              (u) => u.rol === "docente" || u.rol === "profesor"
            );
          }

          usersTable.innerHTML = filteredUsers
            .map(
              (user) => `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${
                          user.id
                        }</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <img class="h-10 w-10 rounded-full" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 40 40'%3E%3Ccircle cx='20' cy='20' r='20' fill='%23e5e7eb'/%3E%3Cpath d='M20 20c3.3 0 6-2.7 6-6s-2.7-6-6-6-6 2.7-6 6 2.7 6 6 6zm0 2c-4 0-12 2-12 6v2h24v-2c0-4-8-6-12-6z' fill='%236b7280'/%3E%3C/svg%3E" alt="">
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900">${
                                      user.nombre
                                    }</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${
                          user.email
                        }</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                              user.rol === "administrador"
                                ? "bg-red-100 text-red-800"
                                : user.rol === "profesor"
                                ? "bg-blue-100 text-blue-800"
                                : "bg-green-100 text-green-800"
                            }">
                                ${
                                  user.rol.charAt(0).toUpperCase() +
                                  user.rol.slice(1)
                                }
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                              user.estado === "activo"
                                ? "bg-green-100 text-green-800"
                                : "bg-red-100 text-red-800"
                            }">
                                ${user.estado}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${
                          user.fechaRegistro
                        }</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="editUser(${
                              user.id
                            })" class="text-indigo-600 hover:text-indigo-900 mr-3">
                                <i class="fas fa-edit"></i>
                            </button>
                            ${
                              user.id !== currentUser.id
                                ? `
                                <button onclick="deleteUser(${user.id})" class="text-red-600 hover:text-red-900">
                                    <i class="fas fa-trash"></i>
                                </button>
                            `
                                : ""
                            }
                        </td>
                    </tr>
                `
            )
            .join("");
        } catch (error) {
          showNotification("Error al cargar usuarios", "error");
        }
      }

      async function loadActivities() {
        try {
          const [activities, users] = await Promise.all([
            fetchData(
              "activities",
              currentUser.rol === "docente" ? currentUser.id : null
            ),
            fetchData("users"),
          ]);

          const activitiesGrid = document.getElementById("activitiesGrid");

          activitiesGrid.innerHTML = activities
            .map((activity) => {
              const user = users.find((u) => u.id === activity.asignadoA);
              const creator = users.find((u) => u.id === activity.creadoPor);
              return `
                        <div class="bg-white rounded-xl card-shadow p-6">
                            <div class="flex justify-between items-start mb-4">
                                <h3 class="text-lg font-semibold text-gray-800">${
                                  activity.titulo
                                }</h3>
                                <span class="px-2 py-1 text-xs rounded-full ${
                                  activity.prioridad === "alta"
                                    ? "bg-red-100 text-red-800"
                                    : activity.prioridad === "media"
                                    ? "bg-yellow-100 text-yellow-800"
                                    : "bg-green-100 text-green-800"
                                }">${activity.prioridad}</span>
                            </div>
                            
                            <p class="text-gray-600 mb-4">${
                              activity.descripcion
                            }</p>
                            
                            <div class="space-y-2 mb-4">
                                <div class="flex items-center text-sm text-gray-600">
                                    <i class="fas fa-calendar mr-2"></i>
                                    Límite: ${activity.fechaLimite}
                                </div>
                                <div class="flex items-center text-sm text-gray-600">
                                    <i class="fas fa-user mr-2"></i>
                                    Asignado: ${
                                      user?.nombre || "Usuario desconocido"
                                    }
                                </div>
                                <div class="flex items-center text-sm text-gray-600">
                                    <i class="fas fa-user-plus mr-2"></i>
                                    Creado por: ${
                                      creator?.nombre || "Usuario desconocido"
                                    }
                                </div>
                                ${
                                  activity.notas
                                    ? `
                                    <div class="flex items-start text-sm text-gray-600">
                                        <i class="fas fa-sticky-note mr-2 mt-1"></i>
                                        <span>${activity.notas}</span>
                                    </div>
                                `
                                    : ""
                                }
                            </div>
                            
                            <div class="flex justify-between items-center">
                                <span class="px-3 py-1 text-sm rounded-full ${
                                  activity.estado === "completada"
                                    ? "bg-green-100 text-green-800"
                                    : activity.estado === "en_progreso"
                                    ? "bg-blue-100 text-blue-800"
                                    : "bg-yellow-100 text-yellow-800"
                                }">${activity.estado.replace("_", " ")}</span>
                                
                                ${
                                  hasPermission("manage_activities")
                                    ? `
                                    <div class="space-x-2">
                                        <button onclick="editActivity(${activity.id})" class="text-indigo-600 hover:text-indigo-800">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button onclick="deleteActivity(${activity.id})" class="text-red-600 hover:text-red-800">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                `
                                    : ""
                                }
                            </div>
                        </div>
                    `;
            })
            .join("");
        } catch (error) {
          showNotification("Error al cargar actividades", "error");
        }
      }

      async function loadTeachers() {
        if (!hasPermission("manage_teachers")) {
          showNotification("No tienes permisos para ver esta sección", "error");
          return;
        }

        try {
          const teachers = await fetchData("teachers");
          const teachersTable = document.getElementById("teachersTable");

          teachersTable.innerHTML = teachers
            .map(
              (teacher) => `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${
                          teacher.id
                        }</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <img class="h-10 w-10 rounded-full" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 40 40'%3E%3Ccircle cx='20' cy='20' r='20' fill='%23e5e7eb'/%3E%3Cpath d='M20 20c3.3 0 6-2.7 6-6s-2.7-6-6-6-6 2.7-6 6 2.7 6 6 6zm0 2c-4 0-12 2-12 6v2h24v-2c0-4-8-6-12-6z' fill='%236b7280'/%3E%3C/svg%3E" alt="">
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900">${
                                      teacher.nombre
                                    }</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${
                          teacher.email
                        }</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${
                          teacher.especialidad
                        }</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${
                          teacher.telefono
                        }</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                              teacher.estado === "activo"
                                ? "bg-green-100 text-green-800"
                                : teacher.estado === "licencia"
                                ? "bg-yellow-100 text-yellow-800"
                                : "bg-red-100 text-red-800"
                            }">
                                ${teacher.estado}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="editTeacher(${
                              teacher.id
                            })" class="text-indigo-600 hover:text-indigo-900 mr-3">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteTeacher(${
                              teacher.id
                            })" class="text-red-600 hover:text-red-900">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `
            )
            .join("");
        } catch (error) {
          showNotification("Error al cargar docentes", "error");
        }
      }

      async function loadReports() {
        if (!hasPermission("view_reports")) {
          showNotification("No tienes permisos para ver esta sección", "error");
          return;
        }

        try {
          const [users, progress] = await Promise.all([
            fetchData("users"),
            fetchData("progress"),
          ]);

          // Cargar usuarios para el selector
          const userSelect = document.getElementById("userSelect");
          let availableUsers = users;

          if (currentUser.rol === "profesor") {
            availableUsers = users.filter(
              (u) => u.rol === "docente" || u.rol === "profesor"
            );
          }

          userSelect.innerHTML =
            '<option value="">Seleccionar usuario</option>' +
            availableUsers
              .map(
                (user) => `<option value="${user.id}">${user.nombre}</option>`
              )
              .join("");

          // Establecer fechas por defecto
          const today = new Date();
          const startDate = new Date(today.getFullYear(), today.getMonth(), 1);
          document.getElementById("startDate").value = startDate
            .toISOString()
            .split("T")[0];
          document.getElementById("endDate").value = today
            .toISOString()
            .split("T")[0];

          // Cargar progreso histórico
          const progressHistoryTable = document.getElementById(
            "progressHistoryTable"
          );
          progressHistoryTable.innerHTML = progress
            .map((progressItem) => {
              const generator = users.find(
                (u) => u.id === progressItem.generadoPor
              );
              return `
                        <tr>
                            <td class="px-4 py-2 text-sm text-gray-900">${
                              progressItem.fecha
                            }</td>
                            <td class="px-4 py-2 text-sm text-gray-900">${
                              progressItem.periodoInicio
                            } - ${progressItem.periodoFin}</td>
                            <td class="px-4 py-2 text-sm text-gray-900">${
                              progressItem.totalActividades
                            }</td>
                            <td class="px-4 py-2 text-sm text-gray-900">${
                              progressItem.completadas
                            }</td>
                            <td class="px-4 py-2 text-sm text-gray-900">${
                              progressItem.totalDocentes
                            }</td>
                            <td class="px-4 py-2 text-sm text-gray-900">${
                              generator?.nombre || "Usuario desconocido"
                            }</td>
                        </tr>
                    `;
            })
            .join("");
        } catch (error) {
          showNotification("Error al cargar reportes", "error");
        }
      }

      function loadProfile() {
        document.getElementById("profileName").textContent = currentUser.nombre;
        document.getElementById("profileRole").textContent =
          currentUser.rol.charAt(0).toUpperCase() + currentUser.rol.slice(1);
        document.getElementById("profileEmail").textContent = currentUser.email;

        // Badge de carrera
        const careerNames = {
          software: "Ingeniería en Software",
          mecatronica: "Ingeniería en Mecatrónica y Manufactura",
        };

        document.getElementById("profileCareerBadge").innerHTML = `
                <span class="px-3 py-1 text-sm font-medium rounded-full ${
                  currentCareer === "software"
                    ? "career-badge-software"
                    : "career-badge-mecatronica"
                }">
                    ${careerNames[currentCareer]}
                </span>
            `;

        document.getElementById("fullName").value = currentUser.nombre;
        document.getElementById("emailProfile").value = currentUser.email;
        document.getElementById("phone").value = currentUser.telefono || "";
        document.getElementById("specialty").value =
          currentUser.especialidad || "";
      }

      // Funciones de gestión
      function addUser() {
        document.getElementById("userModalTitle").textContent =
          "Agregar Usuario";
        document.getElementById("userForm").reset();
        document.getElementById("userModal").classList.remove("hidden");
      }

      async function editUser(userId) {
        try {
          const users = await fetchData("users");
          const user = users.find((u) => u.id === userId);
          if (!user) return;

          document.getElementById("userModalTitle").textContent =
            "Editar Usuario";
          document.getElementById("modalUserName").value = user.nombre;
          document.getElementById("modalUserEmail").value = user.email;
          document.getElementById("modalUserRole").value = user.rol;
          document.getElementById("modalUserPassword").value =
            user.password || "";
          document.getElementById("modalUserPhone").value = user.telefono || "";
          document.getElementById("modalUserSpecialty").value =
            user.especialidad || "";

          document.getElementById("userModal").classList.remove("hidden");
          document.getElementById("userModal").dataset.editId = userId;
        } catch (error) {
          showNotification("Error al cargar usuario", "error");
        }
      }

      async function deleteUser(userId) {
        if (confirm("¿Estás seguro de que deseas eliminar este usuario?")) {
          try {
            await deleteRecord("users", userId);
            loadUsers();
            showNotification("Usuario eliminado exitosamente", "success");
          } catch (error) {
            showNotification("Error al eliminar usuario", "error");
          }
        }
      }

      async function addActivity() {
        document.getElementById("activityModalTitle").textContent =
          "Nueva Actividad";
        document.getElementById("activityForm").reset();

        try {
          // Cargar usuarios disponibles
          const users = await fetchData("users");
          const assigneeSelect = document.getElementById(
            "modalActivityAssignee"
          );
          let availableUsers = users;

          if (currentUser.rol === "profesor") {
            availableUsers = users.filter(
              (u) => u.rol === "docente" || u.rol === "profesor"
            );
          }

          assigneeSelect.innerHTML =
            '<option value="">Seleccionar usuario</option>' +
            availableUsers
              .map(
                (user) => `<option value="${user.id}">${user.nombre}</option>`
              )
              .join("");

          document.getElementById("activityModal").classList.remove("hidden");
        } catch (error) {
          showNotification("Error al cargar usuarios", "error");
        }
      }

      async function editActivity(activityId) {
        try {
          const [activities, users] = await Promise.all([
            fetchData("activities"),
            fetchData("users"),
          ]);

          const activity = activities.find((a) => a.id === activityId);
          if (!activity) return;

          document.getElementById("activityModalTitle").textContent =
            "Editar Actividad";
          document.getElementById("modalActivityTitle").value = activity.titulo;
          document.getElementById("modalActivityDescription").value =
            activity.descripcion;
          document.getElementById("modalActivityDeadline").value =
            activity.fechaLimite;
          document.getElementById("modalActivityPriority").value =
            activity.prioridad;
          document.getElementById("modalActivityStatus").value =
            activity.estado;
          document.getElementById("modalActivityNotes").value =
            activity.notas || "";

          // Cargar usuarios disponibles
          const assigneeSelect = document.getElementById(
            "modalActivityAssignee"
          );
          let availableUsers = users;

          if (currentUser.rol === "profesor") {
            availableUsers = users.filter(
              (u) => u.rol === "docente" || u.rol === "profesor"
            );
          }

          assigneeSelect.innerHTML =
            '<option value="">Seleccionar usuario</option>' +
            availableUsers
              .map(
                (user) => `<option value="${user.id}">${user.nombre}</option>`
              )
              .join("");

          assigneeSelect.value = activity.asignadoA;

          document.getElementById("activityModal").classList.remove("hidden");
          document.getElementById("activityModal").dataset.editId = activityId;
        } catch (error) {
          showNotification("Error al cargar actividad", "error");
        }
      }

      async function deleteActivity(activityId) {
        if (confirm("¿Estás seguro de que deseas eliminar esta actividad?")) {
          try {
            await deleteRecord("activities", activityId);
            loadActivities();
            showNotification("Actividad eliminada exitosamente", "success");
          } catch (error) {
            showNotification("Error al eliminar actividad", "error");
          }
        }
      }

      function addTeacher() {
        document.getElementById("teacherModalTitle").textContent =
          "Agregar Docente";
        document.getElementById("teacherForm").reset();
        document.getElementById("teacherModal").classList.remove("hidden");
      }

      async function editTeacher(teacherId) {
        try {
          const teachers = await fetchData("teachers");
          const teacher = teachers.find((t) => t.id === teacherId);
          if (!teacher) return;

          document.getElementById("teacherModalTitle").textContent =
            "Editar Docente";
          document.getElementById("modalTeacherName").value = teacher.nombre;
          document.getElementById("modalTeacherEmail").value = teacher.email;
          document.getElementById("modalTeacherSpecialty").value =
            teacher.especialidad;
          document.getElementById("modalTeacherPhone").value = teacher.telefono;
          document.getElementById("modalTeacherStatus").value = teacher.estado;
          document.getElementById("modalTeacherNotes").value =
            teacher.notas || "";

          document.getElementById("teacherModal").classList.remove("hidden");
          document.getElementById("teacherModal").dataset.editId = teacherId;
        } catch (error) {
          showNotification("Error al cargar docente", "error");
        }
      }

      async function deleteTeacher(teacherId) {
        if (confirm("¿Estás seguro de que deseas eliminar este docente?")) {
          try {
            await deleteRecord("teachers", teacherId);
            loadTeachers();
            showNotification("Docente eliminado exitosamente", "success");
          } catch (error) {
            showNotification("Error al eliminar docente", "error");
          }
        }
      }

      async function generateIndividualReport() {
        const userId = document.getElementById("userSelect").value;
        if (!userId) {
          showNotification("Por favor selecciona un usuario", "warning");
          return;
        }

        try {
          const users = await fetchData("users");
          const user = users.find((u) => u.id == userId);

          showNotification(
            `Generando reporte individual para ${user.nombre}...`,
            "info"
          );

          const reportData = {
            type: "individual",
            userId: parseInt(userId),
            generatedBy: currentUser.id,
          };

          await generateReport(reportData);
          showNotification(
            "Reporte individual generado exitosamente",
            "success"
          );
        } catch (error) {
          showNotification("Error al generar reporte individual", "error");
        }
      }

      async function generateGeneralReport() {
        const startDate = document.getElementById("startDate").value;
        const endDate = document.getElementById("endDate").value;

        if (!startDate || !endDate) {
          showNotification("Por favor selecciona las fechas", "warning");
          return;
        }

        try {
          showNotification("Generando reporte general...", "info");

          const reportData = {
            type: "general",
            startDate,
            endDate,
            generatedBy: currentUser.id,
          };

          await generateReport(reportData);
          showNotification("Reporte general generado exitosamente", "success");
          loadReports(); // Recargar para mostrar el nuevo progreso
        } catch (error) {
          showNotification("Error al generar reporte general", "error");
        }
      }

      // Event Listeners
      document.addEventListener("DOMContentLoaded", function () {
        // Login form
        document
          .getElementById("loginForm")
          .addEventListener("submit", async function (e) {
            e.preventDefault();
            const career = document.getElementById("career").value;
            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;

            if (!career) {
              showNotification("Por favor selecciona una carrera", "warning");
              return;
            }

            try {
              currentCareer = career;
              const user = await authenticateUser(career, email, password);

              if (user) {
                currentUser = user;

                document.getElementById("loginScreen").classList.add("hidden");
                document.getElementById("dashboard").classList.remove("hidden");

                // Actualizar header
                document.getElementById("headerUserName").textContent =
                  user.nombre;
                document.getElementById("headerUserRole").textContent =
                  user.rol.charAt(0).toUpperCase() + user.rol.slice(1);

                // Mostrar selector de carrera solo para administradores
                if (hasPermission("switch_career")) {
                  document
                    .getElementById("careerSelector")
                    .classList.remove("hidden");
                }

                updateCareerUI();
                generateMenu();
                showSection("overview");

                // Iniciar sincronización en tiempo real
                startRealTimeSync();

                showNotification(
                  `Bienvenido, ${user.nombre}! Sincronización en tiempo real activada`,
                  "success"
                );
              } else {
                showNotification("Credenciales incorrectas", "error");
              }
            } catch (error) {
              showNotification("Error al conectar con Google Sheets", "error");
            }
          });

        // Switch career (solo administradores)
        document
          .getElementById("switchCareer")
          .addEventListener("change", async function (e) {
            if (hasPermission("switch_career")) {
              currentCareer = e.target.value;
              updateCareerUI();
              showSection("overview");
              showNotification(
                `Cambiado a ${e.target.options[e.target.selectedIndex].text}`,
                "info"
              );
            }
          });

        // Configurar detección de red y sincronización
        setupNetworkDetection();

        // Eventos de sincronización
        document
          .getElementById("syncSettingsBtn")
          .addEventListener("click", function (e) {
            e.stopPropagation();
            const dropdown = document.getElementById("syncSettingsDropdown");
            dropdown.classList.toggle("hidden");
            updateSyncStats();
          });

        // Cerrar dropdown al hacer clic fuera
        document.addEventListener("click", function (e) {
          const dropdown = document.getElementById("syncSettingsDropdown");
          const button = document.getElementById("syncSettingsBtn");
          if (!dropdown.contains(e.target) && !button.contains(e.target)) {
            dropdown.classList.add("hidden");
          }
        });

        // Cambiar frecuencia de sincronización
        document
          .getElementById("syncFrequencySelect")
          .addEventListener("change", function (e) {
            const seconds = parseInt(e.target.value);
            setSyncFrequency(seconds);
            showNotification(
              `Frecuencia actualizada: cada ${seconds}s`,
              "info"
            );
          });

        // Toggle sincronización automática
        document
          .getElementById("toggleSyncBtn")
          .addEventListener("click", function () {
            const stats = getSyncStats();
            if (stats.isActive) {
              stopRealTimeSync();
              this.textContent = "Inactiva";
              this.className =
                "px-3 py-1 text-xs bg-red-100 text-red-800 rounded-full";
              showNotification(
                "Sincronización automática desactivada",
                "warning"
              );
            } else {
              startRealTimeSync();
              this.textContent = "Activa";
              this.className =
                "px-3 py-1 text-xs bg-green-100 text-green-800 rounded-full";
              showNotification("Sincronización automática activada", "success");
            }
            updateSyncStats();
          });

        // Logout
        document
          .getElementById("logoutBtn")
          .addEventListener("click", function () {
            // Detener sincronización
            stopRealTimeSync();

            currentUser = null;
            currentCareer = "software";
            cachedData = {
              software: {
                users: [],
                activities: [],
                teachers: [],
                progress: [],
              },
              mecatronica: {
                users: [],
                activities: [],
                teachers: [],
                progress: [],
              },
            };
            lastSyncTime = {};

            document.getElementById("dashboard").classList.add("hidden");
            document.getElementById("loginScreen").classList.remove("hidden");
            document.getElementById("loginForm").reset();
            document.getElementById("careerSelector").classList.add("hidden");
            showNotification("Sesión cerrada exitosamente", "success");
          });

        // User modal events
        document
          .getElementById("addUserBtn")
          .addEventListener("click", addUser);
        document
          .getElementById("closeUserModal")
          .addEventListener("click", () => {
            document.getElementById("userModal").classList.add("hidden");
          });
        document
          .getElementById("cancelUserModal")
          .addEventListener("click", () => {
            document.getElementById("userModal").classList.add("hidden");
          });

        document
          .getElementById("userForm")
          .addEventListener("submit", async function (e) {
            e.preventDefault();
            const editId = document.getElementById("userModal").dataset.editId;

            const userData = {
              nombre: document.getElementById("modalUserName").value,
              email: document.getElementById("modalUserEmail").value,
              rol: document.getElementById("modalUserRole").value,
              password: document.getElementById("modalUserPassword").value,
              telefono: document.getElementById("modalUserPhone").value,
              especialidad: document.getElementById("modalUserSpecialty").value,
            };

            try {
              if (editId) {
                userData.id = parseInt(editId);
                await updateRecord("users", userData);
                showNotification("Usuario actualizado exitosamente", "success");
              } else {
                await createRecord("users", userData);
                showNotification("Usuario agregado exitosamente", "success");
              }

              document.getElementById("userModal").classList.add("hidden");
              delete document.getElementById("userModal").dataset.editId;
              loadUsers();
            } catch (error) {
              showNotification("Error al guardar usuario", "error");
            }
          });

        // Activity modal events
        document
          .getElementById("addActivityBtn")
          .addEventListener("click", addActivity);
        document
          .getElementById("closeActivityModal")
          .addEventListener("click", () => {
            document.getElementById("activityModal").classList.add("hidden");
          });
        document
          .getElementById("cancelActivityModal")
          .addEventListener("click", () => {
            document.getElementById("activityModal").classList.add("hidden");
          });

        document
          .getElementById("activityForm")
          .addEventListener("submit", async function (e) {
            e.preventDefault();
            const editId =
              document.getElementById("activityModal").dataset.editId;

            const activityData = {
              titulo: document.getElementById("modalActivityTitle").value,
              descripcion: document.getElementById("modalActivityDescription")
                .value,
              fechaLimite: document.getElementById("modalActivityDeadline")
                .value,
              prioridad: document.getElementById("modalActivityPriority").value,
              estado: document.getElementById("modalActivityStatus").value,
              asignadoA: parseInt(
                document.getElementById("modalActivityAssignee").value
              ),
              notas: document.getElementById("modalActivityNotes").value,
              creadoPor: currentUser.id,
            };

            try {
              if (editId) {
                activityData.id = parseInt(editId);
                await updateRecord("activities", activityData);
                showNotification(
                  "Actividad actualizada exitosamente",
                  "success"
                );
              } else {
                await createRecord("activities", activityData);
                showNotification("Actividad creada exitosamente", "success");
              }

              document.getElementById("activityModal").classList.add("hidden");
              delete document.getElementById("activityModal").dataset.editId;
              loadActivities();
            } catch (error) {
              showNotification("Error al guardar actividad", "error");
            }
          });

        // Teacher modal events
        document
          .getElementById("addTeacherBtn")
          .addEventListener("click", addTeacher);
        document
          .getElementById("closeTeacherModal")
          .addEventListener("click", () => {
            document.getElementById("teacherModal").classList.add("hidden");
          });
        document
          .getElementById("cancelTeacherModal")
          .addEventListener("click", () => {
            document.getElementById("teacherModal").classList.add("hidden");
          });

        document
          .getElementById("teacherForm")
          .addEventListener("submit", async function (e) {
            e.preventDefault();
            const editId =
              document.getElementById("teacherModal").dataset.editId;

            const teacherData = {
              nombre: document.getElementById("modalTeacherName").value,
              email: document.getElementById("modalTeacherEmail").value,
              especialidad: document.getElementById("modalTeacherSpecialty")
                .value,
              telefono: document.getElementById("modalTeacherPhone").value,
              estado: document.getElementById("modalTeacherStatus").value,
              notas: document.getElementById("modalTeacherNotes").value,
            };

            try {
              if (editId) {
                teacherData.id = parseInt(editId);
                await updateRecord("teachers", teacherData);
                showNotification("Docente actualizado exitosamente", "success");
              } else {
                await createRecord("teachers", teacherData);
                showNotification("Docente agregado exitosamente", "success");
              }

              document.getElementById("teacherModal").classList.add("hidden");
              delete document.getElementById("teacherModal").dataset.editId;
              loadTeachers();
            } catch (error) {
              showNotification("Error al guardar docente", "error");
            }
          });

        // Report events
        document
          .getElementById("generateIndividualReport")
          .addEventListener("click", generateIndividualReport);
        document
          .getElementById("generateGeneralReport")
          .addEventListener("click", generateGeneralReport);

        // Profile events
        document
          .getElementById("saveProfileBtn")
          .addEventListener("click", async function () {
            try {
              const updatedUser = {
                ...currentUser,
                nombre: document.getElementById("fullName").value,
                email: document.getElementById("emailProfile").value,
                telefono: document.getElementById("phone").value,
                especialidad: document.getElementById("specialty").value,
              };

              await updateRecord("users", updatedUser);
              currentUser = updatedUser;

              // Actualizar header
              document.getElementById("headerUserName").textContent =
                currentUser.nombre;

              showNotification("Perfil actualizado exitosamente", "success");
            } catch (error) {
              showNotification("Error al actualizar perfil", "error");
            }
          });

        document
          .getElementById("changePasswordBtn")
          .addEventListener("click", async function () {
            const newPassword = prompt("Ingresa tu nueva contraseña:");
            if (newPassword && newPassword.length >= 6) {
              try {
                const updatedUser = {
                  ...currentUser,
                  password: newPassword,
                };

                await updateRecord("users", updatedUser);
                currentUser = updatedUser;
                showNotification(
                  "Contraseña actualizada exitosamente",
                  "success"
                );
              } catch (error) {
                showNotification("Error al actualizar contraseña", "error");
              }
            } else if (newPassword) {
              showNotification(
                "La contraseña debe tener al menos 6 caracteres",
                "error"
              );
            }
          });

        document
          .getElementById("changePhotoBtn")
          .addEventListener("click", function () {
            showNotification(
              "Funcionalidad de cambio de foto disponible en próxima versión",
              "info"
            );
          });

        document
          .getElementById("resetPasswordBtn")
          .addEventListener("click", function () {
            showNotification(
              "Funcionalidad de recuperación de contraseña disponible en próxima versión",
              "info"
            );
          });
      });

      /**
       * Actualiza las estadísticas de sincronización en el dropdown
       */
      function updateSyncStats() {
        const stats = getSyncStats();
        const statsElement = document.getElementById("syncStats");

        const lastSyncTimes = Object.entries(stats.lastSyncTimes)
          .filter(([key]) => key.startsWith(currentCareer))
          .map(([key, time]) => {
            const type = key.split("_")[1];
            const date = new Date(time);
            return `${type}: ${date.toLocaleTimeString()}`;
          });

        statsElement.innerHTML = `
                <div class="space-y-1">
                    <div>Estado: ${
                      stats.isActive ? "🟢 Activa" : "🔴 Inactiva"
                    }</div>
                    <div>Frecuencia: ${stats.frequency}s</div>
                    <div>Conexión: ${
                      stats.isOnline ? "🟢 Online" : "🔴 Offline"
                    }</div>
                    ${
                      stats.retryAttempts > 0
                        ? `<div>Reintentos: ${stats.retryAttempts}/${maxRetryAttempts}</div>`
                        : ""
                    }
                    ${
                      lastSyncTimes.length > 0
                        ? `
                        <div class="mt-2">
                            <div class="font-medium">Última sincronización:</div>
                            ${lastSyncTimes
                              .map(
                                (time) => `<div class="ml-2">• ${time}</div>`
                              )
                              .join("")}
                        </div>
                    `
                        : ""
                    }
                </div>
            `;
      }

      // Funciones globales para los botones
      window.showSection = showSection;
      window.addUser = addUser;
      window.editUser = editUser;
      window.deleteUser = deleteUser;
      window.addActivity = addActivity;
      window.editActivity = editActivity;
      window.deleteActivity = deleteActivity;
      window.addTeacher = addTeacher;
      window.editTeacher = editTeacher;
      window.deleteTeacher = deleteTeacher;
      window.generateIndividualReport = generateIndividualReport;
      window.generateGeneralReport = generateGeneralReport;
      window.forceSyncNow = forceSyncNow;
    </script>
    <script>
      (function () {
        function c() {
          var b = a.contentDocument || a.contentWindow.document;
          if (b) {
            var d = b.createElement("script");
            d.innerHTML =
              "window.__CF$cv$params={r:'97687b9223224adb',t:'MTc1NjQzMzExOS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";
            b.getElementsByTagName("head")[0].appendChild(d);
          }
        }
        if (document.body) {
          var a = document.createElement("iframe");
          a.height = 1;
          a.width = 1;
          a.style.position = "absolute";
          a.style.top = 0;
          a.style.left = 0;
          a.style.border = "none";
          a.style.visibility = "hidden";
          document.body.appendChild(a);
          if ("loading" !== document.readyState) c();
          else if (window.addEventListener)
            document.addEventListener("DOMContentLoaded", c);
          else {
            var e = document.onreadystatechange || function () {};
            document.onreadystatechange = function (b) {
              e(b);
              "loading" !== document.readyState &&
                ((document.onreadystatechange = e), c());
            };
          }
        }
      })();
    </script>
  </body>
</html>
